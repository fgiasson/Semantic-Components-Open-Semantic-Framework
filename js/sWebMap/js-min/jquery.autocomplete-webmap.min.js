(function(d){function h(a,b,c){b="("+c.replace(j,"\\$1")+")";return a.replace(RegExp(b,"gi"),"<strong>$1</strong>")}function e(a,b){this.el=d(a);this.el.attr("autocomplete","off");this.suggestions=[];this.data=[];this.badQueries=[];this.selectedIndex=-1;this.currentValue=this.el.val();this.intervalId=0;this.cachedResponse=[];this.onChangeInterval=null;this.ignoreValueChange=!1;this.serviceUrl=b.serviceUrl;this.sWebMapRef=b.sWebMapRef;this.isLocal=!1;this.options={autoSubmit:!1,minChars:1,maxHeight:300,
deferRequestBy:0,width:0,highlight:!0,params:{},fnFormatResult:h,delimiter:null,zIndex:9999};this.initialize();this.setOptions(b)}var j=RegExp("(\\/|\\.|\\*|\\+|\\?|\\||\\(|\\)|\\[|\\]|\\{|\\}|\\\\)","g");d.fn.autocomplete=function(a){return new e(this.get(0)||d("<input />"),a)};e.prototype={killerFn:null,initialize:function(){var a,b,c;a=this;b=Math.floor(1048576*Math.random()).toString(16);c="Autocomplete_"+b;this.killerFn=function(b){0===d(b.target).parents(".autocomplete").size()&&(a.killSuggestions(),
a.disableKillerFn())};this.options.width||(this.options.width=this.el.width());this.mainContainerId="AutocompleteContainter_"+b;d('<div id="'+this.mainContainerId+'" style="position:absolute;z-index:9999;"><div class="autocomplete-w1"><div class="autocomplete" id="'+c+'" style="display:none; width:300px;"></div></div></div>').appendTo("body");this.container=d("#"+c);this.fixPosition();window.opera?this.el.keypress(function(b){a.onKeyPress(b)}):this.el.keydown(function(b){a.onKeyPress(b)});this.el.keyup(function(b){a.onKeyUp(b)});
this.el.blur(function(){a.enableKillerFn()});this.el.focus(function(){a.fixPosition();a.onValueChange()})},setOptions:function(a){var b=this.options;d.extend(b,a);b.lookup&&(this.isLocal=!0,d.isArray(b.lookup)&&(b.lookup={suggestions:b.lookup,data:[]}));d("#"+this.mainContainerId).css({zIndex:b.zIndex});this.container.css({maxHeight:b.maxHeight+"px",width:b.width})},clearCache:function(){this.cachedResponse=[];this.badQueries=[]},disable:function(){this.disabled=!0},enable:function(){this.disabled=
!1},fixPosition:function(){var a=this.el.offset();d("#"+this.mainContainerId).css({top:a.top+this.el.innerHeight()+"px",left:a.left+"px"})},enableKillerFn:function(){d(document).bind("click",this.killerFn)},disableKillerFn:function(){d(document).unbind("click",this.killerFn)},killSuggestions:function(){var a=this;this.stopKillSuggestions();this.intervalId=window.setInterval(function(){a.hide();a.stopKillSuggestions()},300)},stopKillSuggestions:function(){window.clearInterval(this.intervalId)},onKeyPress:function(a){if(!this.disabled&&
this.enabled){switch(a.keyCode){case 27:this.el.val(this.currentValue);this.hide();break;case 9:case 13:if(-1===this.selectedIndex){this.hide();return}this.select(this.selectedIndex);if(9===a.keyCode)return;break;case 38:this.moveUp();break;case 40:this.moveDown();break;default:return}a.stopImmediatePropagation();a.preventDefault()}},onKeyUp:function(a){if(!this.disabled){switch(a.keyCode){case 38:case 40:return}clearInterval(this.onChangeInterval);if(this.currentValue!==this.el.val())if(0<this.options.deferRequestBy){var b=
this;this.onChangeInterval=setInterval(function(){b.onValueChange()},this.options.deferRequestBy)}else this.onValueChange()}},onValueChange:function(){clearInterval(this.onChangeInterval);this.currentValue=this.el.val();var a=this.getQuery(this.currentValue);""==a&&0<this.options.minChars||(this.selectedIndex=-1,this.ignoreValueChange?this.ignoreValueChange=!1:(""===a||a.length<this.options.minChars)&&0<this.options.minChars?this.hide():this.getSuggestions(a))},getQuery:function(a){var b;b=this.options.delimiter;
if(!b)return d.trim(a);a=a.split(b);return d.trim(a[a.length-1])},getSuggestionsLocal:function(a){var b,c,d,i,f;c=this.options.lookup;d=c.suggestions.length;b={suggestions:[],data:[]};a=a.toLowerCase();for(f=0;f<d;f++)i=c.suggestions[f],0===i.toLowerCase().indexOf(a)&&(b.suggestions.push(i),b.data.push(c.data[f]));return b},getSuggestions:function(a){var b,c;(b=this.isLocal?this.getSuggestionsLocal(a):this.cachedResponse[a])&&d.isArray(b.suggestions)?(this.suggestions=b.suggestions,this.data=b.data,
this.suggest()):this.isBadQuery(a)||(c=this,void 0==a&&(a=""),c.options.params.query="",toggleWaitingIcon(c.options.params.filterID,c),-1!=c.options.params.attributes.search("::")&&(c.options.params.attributes=c.options.params.attributes.substring(0,c.options.params.attributes.search("::"))),c.options.params.attributes=c.options.params.attributes+"::"+this.urlencode(a+"*")+";"+c.options.params.constrainedAttributes,c.options.params.constrainedAttributes="",d.ajax({type:"POST",url:this.serviceUrl,
data:c.options.params,dataType:"json",query:a,success:function(a){for(var a=new Resultset(a),b=[],d=[],g=0;g<a.subjects.length;g++){var e=a.subjects[g].getPredicateValues("http://purl.org/ontology/aggregate#property");0<e.length&&c.urlencode(e[0].uri)==c.options.params.attributes.substring(0,c.options.params.attributes.search("::"))&&(b.push(a.subjects[g].getPredicateValues("http://purl.org/ontology/aggregate#object")[0]+" ("+a.subjects[g].getPredicateValues("http://purl.org/ontology/aggregate#count")[0]+
")"),d.push({uri:e[0].uri}))}0==b.length&&b.push("No values available");c.processResponse({query:this.query,suggestions:b,data:d});toggleWaitingIcon(c.options.params.filterID,c)},error:function(){toggleWaitingIcon(c.options.params.filterID,c)}}))},isBadQuery:function(a){for(var b=this.badQueries.length;b--;)if(void 0==a||0===a.indexOf(this.badQueries[b]))return!0;return!1},hide:function(){this.enabled=!1;this.selectedIndex=-1;this.container.hide()},suggest:function(){if(0===this.suggestions.length)this.hide();
else{var a,b,c,e,i,f,g,h;a=this;b=this.suggestions.length;e=this.options.fnFormatResult;i=this.getQuery(this.currentValue);g=function(b){return function(){a.activate(b)}};h=function(b){return function(){a.select(b)}};this.container.hide().empty();for(f=0;f<b;f++)c=this.suggestions[f],c=d((a.selectedIndex===f?'<div class="selected"':"<div")+' title="'+c+'">'+e(c,this.data[f],i)+"</div>"),c.mouseover(g(f)),c.click(h(f)),this.container.append(c);this.enabled=!0;this.container.show()}},processResponse:function(a){d.isArray(a.data)||
(a.data=[]);this.options.noCache||(this.cachedResponse[a.query]=a,0===a.suggestions.length&&this.badQueries.push(a.query));a.query===this.getQuery(this.currentValue)&&(this.suggestions=a.suggestions,this.data=a.data,this.suggest(),this.suggest())},activate:function(a){var b,c;b=this.container.children();-1!==this.selectedIndex&&b.length>this.selectedIndex&&d(b.get(this.selectedIndex)).removeClass();this.selectedIndex=a;-1!==this.selectedIndex&&b.length>this.selectedIndex&&(c=b.get(this.selectedIndex),
d(c).addClass("selected"));return c},deactivate:function(a,b){a.className="";this.selectedIndex===b&&(this.selectedIndex=-1)},select:function(a){var b;if(b=this.suggestions[a])this.el.val(b),this.options.autoSubmit&&(b=this.el.parents("form"),0<b.length&&b.get(0).submit()),this.ignoreValueChange=!0,this.hide(),this.onSelect(a)},moveUp:function(){-1!==this.selectedIndex&&(0===this.selectedIndex?(this.container.children().get(0).className="",this.selectedIndex=-1,this.el.val(this.currentValue)):this.adjustScroll(this.selectedIndex-
1))},moveDown:function(){this.selectedIndex!==this.suggestions.length-1&&this.adjustScroll(this.selectedIndex+1)},adjustScroll:function(a){var b,c,d;b=this.activate(a).offsetTop;c=this.container.scrollTop();d=c+this.options.maxHeight-25;b<c?this.container.scrollTop(b):b>d&&this.container.scrollTop(b-this.options.maxHeight+25);a=this.suggestions[a];a=a.substring(0,a.search("&nbsp;&nbsp;&nbsp;"));this.el.val(this.getValue(a))},onSelect:function(a){var b,c;b=this.options.onSelect;c=this.suggestions[a];
var a=this.data[a],e=this.getValue(c),e=e.substring(0,e.search("&nbsp;&nbsp;&nbsp;"));this.el.val(e);d.isFunction(b)&&b(c,a,this.el)},getValue:function(a){var b,c;b=this.options.delimiter;if(!b)return a;c=this.currentValue;b=c.split(b);return 1===b.length?a:c.substr(0,c.length-b[b.length-1].length)+a},urlencode:function(a){a=(a+"").toString();return encodeURIComponent(a).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")}}})(jQuery);
function toggleWaitingIcon(d,h){if($("#addButton_"+d).attr("src")){var e=$("#addButton_"+d).parent();$("#addButton_"+d).remove();e.append('<input id="addButton_'+d+'" type="submit" value="add" />');$("#addButton_"+d).click(function(){var d=this.id.substring(this.id.lastIndexOf("_")+1);h.sWebMapRef.attributeValueFilter(d)})}else e=$("#addButton_"+d).parent(),$("#addButton_"+d).remove(),e.append('<img id="addButton_'+d+'" src="'+h.sWebMapRef.imagesFolder+'ajax-loader-icon.gif" />')};