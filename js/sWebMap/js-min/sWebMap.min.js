$(document).ready(function(){Array.indexOf||(Array.prototype.indexOf=function(g){for(var d=0;d<this.length;d++)if(this[d]==g)return d;return-1})});
function SWebMap(g,d){var b=this;this.defaultMapLat=void 0!=d.defaultMapLat?d.defaultMapLat:"46.8415";this.defaultMapLong=void 0!=d.defaultMapLong?d.defaultMapLong:"-71.3198";this.defaultMapZoom=void 0!=d.defaultMapZoom?d.defaultMapZoom:10;this.defaultMarkerUrl=void 0!=d.defaultMarkerUrl?d.defaultMarkerUrl:"";this.displayAttributeFiltersCounts=void 0!=d.displayAttributeFiltersCounts?d.displayAttributeFiltersCounts:!1;this.displayResultsHTML=void 0!=d.displayResultsHTML?d.displayResultsHTML:!0;this.displayFilters=
void 0!=d.displayFilters?d.displayFilters:!0;this.displayTypeFiltersCounts=void 0!=d.displayTypeFiltersCounts?d.displayTypeFiltersCounts:!1;this.enableFocusWindows=void 0!=d.enableFocusWindows?d.enableFocusWindows:!1;this.enableRecordDisplayOverlay=void 0!=d.enableRecordDisplayOverlay?d.enableRecordDisplayOverlay:!0;this.enableRecordSelection=void 0!=d.enableRecordSelection?d.enableRecordSelection:!0;this.enableSessions=void 0!=d.enableSessions?d.enableSessions:!0;this.focusMapsCenterPositions=void 0!=
d.focusMapsCenterPositions?d.focusMapsCenterPositions:{focusMap1:{lat:"46.7659",lng:"-71.3198",zoom:12},focusMap2:{lat:"46.8056",lng:"-71.3153",zoom:12},focusMap3:{lat:"46.8303",lng:"-71.2216",zoom:12}};this.forceSearch=void 0!=d.forceSearch?d.forceSearch:!1;this.googleUrlShortenerKey=void 0!=d.googleUrlShortenerKey?d.googleUrlShortenerKey:"";this.imagesFolder=void 0!=d.imagesFolder?d.imagesFolder:"";this.includeResultsInTargetInclusionRecords=void 0!=d.includeResultsInTargetInclusionRecords?d.includeResultsInTargetInclusionRecords:
!1;this.initializationSession=void 0!=d.initializationSession?d.initializationSession:null;this.isAdmin=void 0!=d.isAdmin?d.isAdmin:!1;this.labels={};void 0==d.labels&&(d.labels={});this.labels.searchButton="undefined"!=typeof d.labels.searchButton?d.labels.searchButton:"Search";this.labels.searchInput="undefined"!=typeof d.labels.sesearchInputarchButton?d.labels.searchInput:"Search Map";this.labels.saveSessionButton="undefined"!=typeof d.labels.saveSessionButton?d.labels.saveSessionButton:"save";
this.labels.deleteSessionButton="undefined"!=typeof d.labels.deleteSessionButton?d.labels.deleteSessionButton:"delete";this.labels.shareSessionButton="undefined"!=typeof d.labels.shareSessionButton?d.labels.shareSessionButton:"share";this.labels.loadSavedMapSessionInput="undefined"!=typeof d.labels.loadSavedMapSessionInput?d.labels.loadSavedMapSessionInput:"Load saved map...";this.labels.sourcesFilterSectionHeader="undefined"!=typeof d.labels.sourcesFilterSectionHeader?d.labels.sourcesFilterSectionHeader:
"Sources";this.labels.typesFilterSectionHeader="undefined"!=typeof d.labels.typesFilterSectionHeader?d.labels.typesFilterSectionHeader:"Kinds";this.labels.attributesFilterSectionHeader="undefined"!=typeof d.labels.attributesFilterSectionHeader?d.labels.attributesFilterSectionHeader:"Attributes";this.labels.inclusionRecordsButtonOff="undefined"!=typeof d.labels.inclusionRecordsButtonOff?d.labels.inclusionRecordsButtonOff:"Show included records";this.labels.inclusionRecordsButtonOn="undefined"!=typeof d.labels.inclusionRecordsButtonOn?
d.labels.inclusionRecordsButtonOn:"Show all records";this.mapDatasets=void 0!=d.mapDatasets?d.mapDatasets:[];this.schemas=void 0!=d.schemas?d.schemas:[];this.mapResultsPerPage=void 0!=d.mapResultsPerPage?d.mapResultsPerPage:20;this.searchOnDrag=void 0!=d.searchOnDrag?d.searchOnDrag:!1;this.searchOnZoomChanged=void 0!=d.searchOnZoomChanged?d.searchOnZoomChanged:!1;this.sharedMapUrl=void 0!=d.sharedMapUrl?d.sharedMapUrl:"";this.structWSFAddress=void 0!=d.structWSFAddress?d.structWSFAddress:"http://localhost/ws/search/";
this.recordDisplayCss=void 0!=d.recordDisplayCss?d.recordDisplayCss:"";this.inclusionRecords=void 0!=d.inclusionRecords?d.inclusionRecords:[];this.session={name:"",notes:"",q:"",fd:[],fa:[],ft:[],av:{},attributes_boolean_operator:"and",records:[]};this.taggedRecords=[];this.currentResultsetPage=this.nbResults=0;this.datasetsTitles=[];this.markers=[];this.polygons=[];this.polylines=[];this.selectedMapId=-1;this.mapLoading=!1;this.templatesData=[];this.filtersDatasets=[];this.filtersTypes=[];this.filtersAttributes=
[];this.checkedFiltersDatasets=[];this.checkedFiltersTypes=[];this.checkedFiltersAttributes=[];this.attributeValueFilters={};this.results=[];this.taggedResults=[];this.letters="a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z".split(",");this.focusMaps=[];this.focusMapsResults={1:null,2:null,3:null};this.focusMapsTaggedRecords={1:[],2:[],3:[]};this.howManyFocusMapsCreated=0;this.selectedFocusMapID=-1;this.createWebMap=function(c){var a="",f=b.getUrlVars();void 0!=f.map&&""!=f.map&&"function"!=
typeof f.map&&JSON.parse(unescape(f.map)).fwe&&(this.enableFocusWindows=!0);this.enableFocusWindows&&(a='<tr><td colspan="2" style="width: 100%"><table id="webMapFocusWindows"><tr><td style="padding: 0px; width: 33%;"><div id="mapFocus1" class="mapFocus1_unselected"></div></td><td style="padding: 0px; width: 34%;"><div id="mapFocus2" class="mapFocus2_unselected"></div></td><td style="padding: 0px; width: 33%;"><div id="mapFocus3" class="mapFocus3_unselected"></div></td></tr></table></td></tr>');$("#"+
c).append(' <div id="mapSessionsPanel" class="mapSessionsPanel" ></div><div id="mapSessionsMessagePanel" class="mapSessionsMessagePanel" ></div><div id="webMapSearch" class="webMapSearch" ></div><div id="webMapMain" class="webMapMain"></div><table id="webMap" class="webMap"><tbody style="border: none;">'+a+'<tr id="resultsCanvas"><td valign="top" class="webMapResultsTd"><div class="webMapResults" id="webMapResults"><div id="mapActionsButtons" class="mapActionsButtons"></div><div id="taggedRecordsBox" class="taggedRecordsBox"></div><div id="resultsBox" class="resultsBox"></div><div id="resultsPaginator" class="resultsPaginator"></div></div></td><td class="webMapFiltersTd" valign="top"><div id="webMapFilters" class="webMapFilters"></div></td></tr></tbody></table><div id="recordDescriptionOverlay" />');
$("#webMap").width($("#webMap").parent().width());$(".webMapFiltersTd").width(0.35*$("#webMap").width());$(".webMapResultsTd").width(0.65*$("#webMap").width());this.enableFocusWindows&&($("#mapFocus1").width($("#mapFocus1").width()),$("#mapFocus2").width($("#mapFocus2").width()),$("#mapFocus3").width($("#mapFocus3").width()));$("#recordDescriptionOverlay").hide();c={zoom:this.defaultMapZoom,center:new google.maps.LatLng(this.defaultMapLat,this.defaultMapLong),mapTypeId:google.maps.MapTypeId.ROADMAP};
this.map=new google.maps.Map(document.getElementById("webMapMain"),c);google.maps.event.addListenerOnce(this.map,"idle",function(){google.maps.event.addListener(b.map,"dragend",function(){!b.mapLoading&&b.searchOnDrag&&!b.enableFocusWindows&&b.search()});google.maps.event.addListener(b.map,"zoom_changed",function(){!b.mapLoading&&b.searchOnZoomChanged&&!b.enableFocusWindows&&b.search()});b.enableFocusWindows&&(b.focusMaps.push(new SWebMapFocus),$("#mapFocus"+b.focusMaps.length).parent().css("height",
"300px"),b.focusMaps[b.focusMaps.length-1].createFocusMap(b,"mapFocus"+b.focusMaps.length),b.focusMaps[b.focusMaps.length-1].focusPolygon=b.drawFocusPolygon(b.focusMaps[b.focusMaps.length-1],$("#mapFocus"+b.focusMaps.length).css("border-top-color")),google.maps.event.addListenerOnce(b.focusMaps[b.focusMaps.length-1].map,"idle",function(){b.howManyFocusMapsCreated++}),b.focusMaps.push(new SWebMapFocus),$("#mapFocus"+b.focusMaps.length).parent().css("height","300px"),b.focusMaps[b.focusMaps.length-
1].createFocusMap(b,"mapFocus"+b.focusMaps.length),b.focusMaps[b.focusMaps.length-1].focusPolygon=b.drawFocusPolygon(b.focusMaps[b.focusMaps.length-1],$("#mapFocus"+b.focusMaps.length).css("border-top-color")),google.maps.event.addListenerOnce(b.focusMaps[b.focusMaps.length-1].map,"idle",function(){b.howManyFocusMapsCreated++}),b.focusMaps.push(new SWebMapFocus),$("#mapFocus"+b.focusMaps.length).parent().css("height","300px"),b.focusMaps[b.focusMaps.length-1].createFocusMap(b,"mapFocus"+b.focusMaps.length),
b.focusMaps[b.focusMaps.length-1].focusPolygon=b.drawFocusPolygon(b.focusMaps[b.focusMaps.length-1],$("#mapFocus"+b.focusMaps.length).css("border-top-color")),google.maps.event.addListenerOnce(b.focusMaps[b.focusMaps.length-1].map,"idle",function(){b.howManyFocusMapsCreated++}));if(b.enableSessions){var a=document.createElement("DIV");new b.SaveButtonControl(a,b.map);a.index=1;b.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(a);a=document.createElement("DIV");a.id="deleteButtonDiv";new b.DeleteButtonControl(a,
b.map);a.index=1;b.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(a);$(a).hide();a=document.createElement("DIV");a.id="inclusionButtonDiv";new b.InclusionButtonControl(a,b.map);a.index=1;b.map.controls[google.maps.ControlPosition.BOTTOM_RIGHT].push(a);$(a).hide();""!=b.googleUrlShortenerKey&&""!=b.sharedMapUrl&&(a=document.createElement("DIV"),a.id="linkButtonDiv",new b.LinkButtonControl(a,b.map),a.index=1,b.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(a),$(a).hide());a=document.createElement("DIV");
a.id="selectMapDiv";new b.SelectMapControl(a,b.map);0>=b.getSessions().length&&$(a).hide();a.index=1;b.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(a)}$("#webMapMain").css("background-color","");b.displaySearch();null!=$.cookie("webmap-resultsperpage")&&(b.mapResultsPerPage=$.cookie("webmap-resultsperpage"));if(void 0!=f.map&&""!=f.map&&"function"!=typeof f.map)if(b.startWaiting(),b.mapLoading=!0,a=JSON.parse(unescape(f.map)),b.enableFocusWindows){var c=function(a){if(3==b.howManyFocusMapsCreated){b.checkedFiltersDatasets=
a.fd;b.checkedFiltersTypes=a.ft;b.checkedFiltersAttributes=a.fa;b.attributeValueFilters=a.av;""!=a.notes&&($("#mapSessionsMessagePanel").empty(),$("#mapSessionsMessagePanel").append('<table style="margin: 20px;"><tbody style="border: none;"><tr><td><h2 style="margin: 0px;">Notes:</h2><br />'+a.notes+"</td></tr></tbody></table>"),$("#mapSessionsMessagePanel").fadeIn("slow",function(){}));var f=!1;if(a.fwe){if(0<a.f1.r.length||0<a.f2.r.length||0<a.f3.r.length)f=!0}else 0<a.records.length&&(f=!0);f&&
b.loadMap(a)}else setTimeout(c,250,a)};setTimeout(c,250,a)}else b.loadMap(a);else"undefined"!=typeof b.initializationSession&&null!=b.initializationSession?(b.startWaiting(),b.mapLoading=!0,b.initializeMap(),sessionInitialized=!0,b.stopWaiting(),b.mapLoading=!1):b.forceSearch&&b.search()})};this.search=function(){this.enableFocusWindows?this.searchMap(this.focusMaps[this.selectedFocusMapID-1].map):this.searchMap(this.map)};this.searchMap=function(c){""!=this.session.q&&this.session.q!=this.labels.searchInput&&
(this.session.q=$("#searchInput").val());var a="",f="",h="";if(0<this.session.fd.length){for(var e=0;e<this.session.fd.length;e++)a=a+this.session.fd[e]+";";a=a.substr(0,a.length-1)}else a=this.mapDatasets.join(";");if(0<this.session.ft.length){for(e=0;e<this.session.ft.length;e++)f=f+this.session.ft[e]+";";f=f.substr(0,f.length-1)}else f="all";var e=0,k;for(k in this.session.av)if(this.session.av.hasOwnProperty(k)){e++;break}if(0<e){for(k in this.session.av)this.session.av.hasOwnProperty(k)&&(h=
h+this.urlencode(k)+"::"+this.urlencode(this.session.av[k])+";");h=h.substr(0,h.length-1)}else h="all";if(this.includeResultsInTargetInclusionRecords){"all"==h&&(h="");for(k=0;k<this.inclusionRecords.length;k++)h=h+";"+this.urlencode("http://www.geonames.org/ontology#locatedIn")+"::"+this.urlencode(this.inclusionRecords[k])+";";this.session.attributes_boolean_operator=1<this.inclusionRecords.length?"or":"and"}e=c.getBounds();k=e.getNorthEast();e=e.getSouthWest();this.startWaiting();$.ajax({type:"POST",
url:this.structWSFAddress.replace(/\/+$/,"")+"/search/",data:"query="+($("#searchInput").val()==this.labels.searchInput?"":$("#searchInput").val())+"&datasets="+a+"&types="+f+"&attributes="+h+"&items="+this.mapResultsPerPage+"&page="+this.currentResultsetPage*this.mapResultsPerPage+"&inference="+(void 0!=this.session.inference&&"on"==this.session.inference?"on":"off")+"&attributes_boolean_operator="+this.session.attributes_boolean_operator+"&include_aggregates="+(this.displayFilters?"true":"false")+
"&range_filter="+k.lat()+";"+k.lng()+";"+e.lat()+";"+e.lng(),dataType:"json",targetMap:c,success:function(a){"mapFocus1"==this.targetMap.b.id&&(b.focusMapsResults["1"]=a);"mapFocus2"==this.targetMap.b.id&&(b.focusMapsResults["2"]=a);"mapFocus3"==this.targetMap.b.id&&(b.focusMapsResults["3"]=a);"webMapMain"==this.targetMap.b.id&&(b.mainMapResults=a);b.prepareDisplayResults(a,this.targetMap)},error:function(){b.stopWaiting()}})};this.prepareDisplayResults=function(c,a){var f=new Resultset(c);b.nbResults=
0;var h=f.getSubjectsByType("http://purl.org/ontology/aggregate#Aggregate"),e=f.getSubjectsByPredicateObjectValue("http://purl.org/ontology/aggregate#property","http://rdfs.org/ns/void#Dataset",h);null!=$.cookie("webmap-datasetsTitles")&&(b.datasetsTitles=JSON.parse(unescape($.cookie("webmap-datasetsTitles"))));for(h=0;h<b.filtersDatasets.length;h++)b.filtersDatasets[h].selected=!1,b.filtersDatasets[h].nbRecords=0;for(var k=0;k<e.length;k++){var h=e[k],d=h.predicate[1]["http://purl.org/ontology/aggregate#object"].uri,
j=h.predicate[2]["http://purl.org/ontology/aggregate#count"];b.datasetsTitles[d]||b.getDatasetsTitles();var l=!1;-1!=b.checkedFiltersDatasets.indexOf(d)&&(l=!0);for(var h=!1,g=0;g<b.filtersDatasets.length;g++)b.filtersDatasets[g].uri==d&&(b.filtersDatasets[g].selected=l,b.filtersDatasets[g].nbRecords=j,h=!0);!1==h&&b.filtersDatasets.push({prefLabel:b.datasetsTitles[d],nbRecords:j,uri:d,selected:l})}h=f.getSubjectsByType("http://purl.org/ontology/aggregate#Aggregate");k=f.getSubjectsByPredicateObjectValue("http://purl.org/ontology/aggregate#property",
"http://www.w3.org/1999/02/22-rdf-syntax-ns#type",h);for(h=0;h<b.filtersTypes.length;h++)b.filtersTypes[h].selected=!1,b.filtersTypes[h].nbRecords=0;for(e=0;e<k.length;e++){for(var h=k[e],o=h.predicate[1]["http://purl.org/ontology/aggregate#object"].uri,j=h.predicate[2]["http://purl.org/ontology/aggregate#count"],d=o,l=0;l<b.schemas.length;l++){var n=b.schemas[l].getType(o);if(null!=n){d=n.prefLabel;break}}null==n&&(-1!=o.lastIndexOf("#")?d=o.substring(o.lastIndexOf("#")+1).replace(/_/g," ").replace(/([A-Z])/g,
" $1").replace(/^\s+|\s+$/g,""):-1!=o.lastIndexOf("/")&&(d=o.substring(o.lastIndexOf("/")+1).replace(/_/g," ").replace(/([A-Z])/g," $1").replace(/^\s+|\s+$/g,"")));l=!1;-1!=b.checkedFiltersTypes.indexOf(o)&&(l=!0);h=!1;for(g=0;g<b.filtersTypes.length;g++)b.filtersTypes[g].uri==o&&(b.filtersTypes[g].selected=l,b.filtersTypes[g].nbRecords=j,h=!0);!1==h&&b.filtersTypes.push({prefLabel:d,nbRecords:j,uri:o,selected:l})}h=f.getSubjectsByType("http://purl.org/ontology/aggregate#Aggregate");n=f.getSubjectsByPredicateObjectValue("http://purl.org/ontology/aggregate#property",
"http://www.w3.org/1999/02/22-rdf-syntax-ns#Property",h);for(h=0;h<b.filtersAttributes.length;h++)b.filtersAttributes[h].selected=!1,b.filtersAttributes[h].nbRecords=0;for(e=0;e<n.length;e++){h=n[e];k=h.predicate[1]["http://purl.org/ontology/aggregate#object"].uri;j=h.predicate[2]["http://purl.org/ontology/aggregate#count"];d=k;for(l=0;l<b.schemas.length;l++){var m=b.schemas[l].getAttribute(k);if(null!=m){d=m.prefLabel;break}}null==m&&(-1!=k.lastIndexOf("#")?d=k.substring(k.lastIndexOf("#")+1).replace(/_/g,
" ").replace(/([A-Z])/g," $1").replace(/^\s+|\s+$/g,""):-1!=k.lastIndexOf("/")&&(d=k.substring(k.lastIndexOf("/")+1).replace(/_/g," ").replace(/([A-Z])/g," $1").replace(/^\s+|\s+$/g,"")));l=!1;-1!=b.checkedFiltersAttributes.indexOf(k)&&(l=!0);h=!1;for(g=0;g<b.filtersAttributes.length;g++)b.filtersAttributes[g].uri==k&&(b.filtersAttributes[g].selected=l,b.filtersAttributes[g].nbRecords=j,h=!0);!1==h&&b.filtersAttributes.push({prefLabel:d,nbRecords:j,uri:k,selected:l})}b.results=[];for(l=0;l<f.subjects.length;l++)m=
f.subjects[l],"http://purl.org/ontology/aggregate#Aggregate"==m.type&&"http://rdfs.org/ns/void#Dataset"==m.getPredicateValues("http://purl.org/ontology/aggregate#property")[0].uri&&(b.nbResults+=parseInt(m.getPredicateValues("http://purl.org/ontology/aggregate#count")[0])),"http://purl.org/ontology/aggregate#Aggregate"!=m.type&&(h=b.getResultDefinition(m),b.results.push(h));this.displayResultsHTML&&(b.displayResultsPagination(b.nbResults,b.currentResultsetPage),b.displayResults(),b.displayTaggedRecords(this.taggedResults),
this.displayFilters?(b.displayFiltersDataset(),b.displayFiltersType(),b.displayFiltersAttribute()):$(".webMapFiltersTd").hide());b.hideUntaggedRecords();for(l=0;l<f.subjects.length;l++)if(m=f.subjects[l],"http://purl.org/ontology/aggregate#Aggregate"!=m.type){h=!1;for(n=0;n<b.markers.length;n++)if(j=b.markers[n],j.data.uri==m.uri){h=!0;j.setVisible(!0);break}if(!h&&(j=m.getPredicateValues("http://www.w3.org/2003/01/geo/wgs84_pos#lat"),g=m.getPredicateValues("http://www.w3.org/2003/01/geo/wgs84_pos#long"),
1==j.length&&1==g.length)){e="";for(k=0;k<b.schemas.length;k++)if(n=b.schemas[k].getType(m.type),null!=n&&void 0!=n.mapMarkerImageUrl&&null!=n.mapMarkerImageUrl){e=n.mapMarkerImageUrl[0];break}""==e&&""!=this.defaultMarkerUrl&&(e=this.defaultMarkerUrl);n=""!=e?{icon:e,position:new google.maps.LatLng(j[0],g[0]),map:a,title:b.stripHtml(m.getPrefLabel())}:{position:new google.maps.LatLng(j[0],g[0]),map:a,title:b.stripHtml(m.getPrefLabel())};j=new google.maps.Marker(n);j.data=m;google.maps.event.addListener(j,
"mouseover",function(){b.featureOver(this.data.uri)});b.markers.push(j)}if(!h){for(var r=0;r<b.polygons.length;r++)g=b.polygons[r],g.data.uri==m.uri&&(h=!0,g.setMap(a));if(!h)for(var j=m.getPredicateValues("http://purl.org/ontology/sco#polygonCoordinates"),p=null,n=0;n<j.length;n++){g=j[n].split(" ");o=[];d=new google.maps.LatLngBounds;for(e=0;e<g.length;e++)k=g[e],k=k.split(","),o.push(new google.maps.LatLng(k[1],k[0])),d=d.extend(new google.maps.LatLng(k[1],k[0])),null==p&&(p=new google.maps.LatLng(k[1],
k[0]));g=new google.maps.Polygon({paths:o,strokeColor:"#CA2251",strokeOpacity:0.7,strokeWeight:2,fillColor:"#CA2251",fillOpacity:0.05});g.data=m;g.bounds=d;e=document.createElement("div");e.style.cssText="border: 1px solid #E48E1A; margin-top: 8px; background: #E48E1A; padding: 5px; color: black;";e.innerHTML=m.getPrefLabel();e={content:e,disableAutoPan:!1,maxWidth:0,pixelOffset:new google.maps.Size(-140,0),zIndex:null,boxStyle:{background:"",opacity:0.75,width:"150px"},closeBoxMargin:"10px 2px 2px 2px",
closeBoxURL:"",infoBoxClearance:new google.maps.Size(1,1),isHidden:!0,pane:"floatPane",enableEventPropagation:!1,position:p};e=new InfoBox(e);e.open(a);g.infobox=e;google.maps.event.addListener(g,"mouseout",function(){this.infobox.hide()});google.maps.event.addListener(g,"mouseover",function(){this.infobox.show();b.featureOver(this.data.uri)});b.polygons.push(g);g.setMap(a)}}if(!h){for(n=0;n<b.polylines.length;n++)j=b.polylines[n],j.data.uri==m.uri&&(h=!0,j.setMap(a));if(!h){h=m.getPredicateValues("http://purl.org/ontology/sco#polylineCoordinates");
for(n=0;n<h.length;n++){g=h[n].split(" ");j=[];d=new google.maps.LatLngBounds;for(e=0;e<g.length;e++)k=g[r],k=k.split(","),j.push(new google.maps.LatLng(k[1],k[0])),d=d.extend(new google.maps.LatLng(k[1],k[0])),null==p&&(p=new google.maps.LatLng(k[1],k[0]));j=new google.maps.Polyline({path:j,strokeColor:"#CA2251",strokeOpacity:0.7,strokeWeight:2,fillColor:"#CA2251",fillOpacity:0.05});j.data=m;j.bounds=d;e=document.createElement("div");e.style.cssText="border: 1px solid #E48E1A; margin-top: 8px; background: #E48E1A; padding: 5px; color: black;";
e.innerHTML=m.getPrefLabel();e={content:e,disableAutoPan:!1,maxWidth:0,pixelOffset:new google.maps.Size(-140,0),zIndex:null,boxStyle:{background:"",opacity:0.75,width:"150px"},closeBoxMargin:"10px 2px 2px 2px",closeBoxURL:"",infoBoxClearance:new google.maps.Size(1,1),isHidden:!0,pane:"floatPane",enableEventPropagation:!1,position:p};e=new InfoBox(e);e.open(a);j.infobox=e;google.maps.event.addListener(j,"mouseout",function(){b.infobox.hide()});google.maps.event.addListener(j,"mouseover",function(){b.infobox.show();
b.featureOver(this.data.uri)});b.polylines.push(j);j.setMap(a)}}}}b.stopWaiting()};this.stripHtml=function(c){var a=document.createElement("DIV");a.innerHTML=c;return a.textContent||a.innerText};this.displayTaggedRecords=function(c){this.taggedResults=c;$(".result-tag").remove();$("#taggedRecordsBox").show();0<c.length?($("#taggedRecordsBox").append('<div id="showSelectedRecordsOnlyDiv" class="result-tag"><span>Show selected records only <input type="checkbox" name="showSelectedRecordsOnlyCheckbox" id="showSelectedRecordsOnlyCheckbox" title=""></span></div>'),
$("#showSelectedRecordsOnlyCheckbox").click(function(){void 0!=this.checked&&(this.checked?b.clearMap():b.search())})):$("#showSelectedRecordsOnlyDiv").remove();for(var a=0;a<c.length;a++){for(var f=c[a].resultset,h={},e=0;e<f.predicate.length;e++)for(var k in f.predicate[e])void 0!=f.predicate[e][k].uri?h[k.replace(":","_").replace(/[^A-Za-z0-9_-]/g,"-")]=f.predicate[e][k].uri:h[k.replace(":","_").replace(/[^A-Za-z0-9_-]/g,"-")]=f.predicate[e][k];this.templatesData.push(h);-1==this.taggedRecords.indexOf(c[a].uri)&&
this.taggedRecords.push(c[a].uri);$("#taggedRecordsBox").append('<div id="tagged_result_'+a+'" class="result-tag"></div>');$("#tagged_result_"+a).mouseover(function(){var a=this.id.substring(this.id.lastIndexOf("_")+1);b.recordOver(b.taggedRecords[a])}).mouseout(function(){var a=this.id.substring(this.id.lastIndexOf("_")+1);b.recordOut(b.taggedRecords[a])});$("#tagged_result_"+a).append('<table class="taggedResultTable"><tr><td id="tagged_result_column_left_'+a+'" class="resultLeftColumn"></td><td id="tagged_result_column_image_'+
a+'" class="resultImageColumn"></td><td id="tagged_result_column_center_'+a+'"  class="resultCenterColumn"></td><td id="tagged_result_column_right_'+a+'" class="resultRightColumn"></td></tr></div>');$("#tagged_result_column_left_"+a).append(this.letters[a]+". ");""!=c[a].markerImageUrl?($("#tagged_result_column_image_"+a).attr("title",c[a].typePrefLabel),$("#tagged_result_column_image_"+a).append('<img src="'+c[a].markerImageUrl+'" />')):""!=c[a].polygonColor?($("#tagged_result_column_image_"+a).attr("title",
c[a].typePrefLabel),$("#tagged_result_column_image_"+a).append('<div id="tagged_result_column_canvas_'+a+'" style="top:-3px;left:20px;position:relative;width:60px;height:30px;"></div>'),f=new jsGraphics(document.getElementById("tagged_result_column_canvas_"+a)),e=new jsColor(c[a].polygonColor.replace("0x","#")),f.fillPolygon(e,[new jsPoint(3,5),new jsPoint(11,6),new jsPoint(17,9),new jsPoint(15,17),new jsPoint(12,21),new jsPoint(17,22),new jsPoint(21,27),new jsPoint(15,31),new jsPoint(6,28),new jsPoint(1,
25),new jsPoint(-1,14)])):""!=c[a].polylineColor?($("#tagged_result_column_image_"+a).attr("title",c[a].typePrefLabel),$("#tagged_result_column_image_"+a).append('<div id="tagged_result_column_canvas_'+a+'" style="top:-3px;left:20px;position:relative;width:60px;height:30px;"></div>'),f=new jsGraphics(document.getElementById("tagged_result_column_canvas_"+a)),e=new jsColor(c[a].polylineColor.replace("0x","#")),e=new jsPen(e,2),f.drawPolyline(e,[new jsPoint(2,2),new jsPoint(13,8),new jsPoint(5,17),
new jsPoint(19,18)])):($("#tagged_result_column_image_"+a).attr("title",c[a].typePrefLabel),$("#tagged_result_column_image_"+a).append('<img src="'+this.defaultMarkerUrl+'" />'));if(this.isAdmin){var f="",d;for(d in this.templatesData[a])f+=d+" = "+this.templatesData[a][d].replace(/"/,"").replace(/'/,"")+"\\n";$("#tagged_result_column_right_"+a).append('<img title="See record data (used for templating purposes)" src="'+this.imagesFolder+'application_form_edit.png" onclick="alert(\''+f+'\');" style="cursor:pointer; padding-right: 3px;" />')}this.enableRecordSelection&&
($("#tagged_result_column_right_"+a).append('<input type="checkbox" name="tagged_result_checkbox_'+a+'" title="Persist this result" checked>'),$("#tagged_result_column_right_"+a+" > input").click(function(){var a=this.parentNode.id.substring(this.parentNode.id.lastIndexOf("_")+1);b.tagRecord(this,c[a].uri)}));void 0!=templates[c[a].type]?($("#tagged_result_column_center_"+a).append(templates[c[a].type]),"undefined"!=typeof templatesDirectives&&void 0!=templatesDirectives[c[a].type]?$("#tagged_result_column_center_"+
a+" > div").autoRender(h,templatesDirectives[c[a].type]):$("#tagged_result_column_center_"+a+" > div").autoRender(h),$("#tagged_result_column_center_"+a+" > div a[href='']").remove(),$("#tagged_result_column_center_"+a+" > div img[src='']").remove(),$("#tagged_result_column_center_"+a).find(".resultTitle").data("id",a),$("#tagged_result_column_center_"+a).find(".resultTitle").click(function(){b.enableRecordDisplayOverlay?b.openRecordDescriptionOverlay($(this).data("id"),!0):window.open(b.taggedResults[$(this).data("id")].uri,
"_blank")})):($("#tagged_result_column_center_"+a).append('<div class="resultTitle"><a>'+c[a].prefLabel+"</a></div>"),$("#tagged_result_column_center_"+a).append('<div class="resultDescription">'+c[a].description+"</div>"),$("#tagged_result_column_center_"+a+" > div > a").click(function(){var a=this.parentNode.parentNode.id.substring(this.parentNode.parentNode.id.lastIndexOf("_")+1);b.enableRecordDisplayOverlay?b.openRecordDescriptionOverlay(a,!0):window.open(b.taggedResults[a].uri,"_blank")}));$("#tagged_result_"+
a).mouseover(function(){this.id.substring(this.id.lastIndexOf("_")+1)}).mouseout(function(){this.id.substring(this.id.lastIndexOf("_")+1)})}};this.featureOver=function(c){for(var a=0;a<this.taggedRecords.length;a++)if(this.taggedRecords[a]==c){$("#webMapResults").scrollTo("#tagged_result_"+a);this.highlightTaggedResult(a);return}for(a=0;a<this.results.length;a++)if(this.results[a].uri==c){$("#webMapResults").scrollTo("#result_"+a);this.highlightResult(a);break}};this.recordOver=function(c){for(var a=
0;a<this.markers.length;a++){var b=this.markers[a];if(b.data.uri==c){b.setAnimation(google.maps.Animation.BOUNCE);return}}for(a=0;a<this.polygons.length;a++)if(b=this.polygons[a],b.data.uri==c){b.setOptions({strokeColor:"#99CCFF",fillColor:"#99CCFF"});return}for(a=0;a<this.polylines.length;a++)if(b=this.polylines[a],b.data.uri==c){b.setOptions({strokeColor:"#99CCFF",fillColor:"#99CCFF"});break}};this.recordOut=function(c){for(var a=0;a<this.markers.length;a++){var b=this.markers[a];if(b.data.uri==
c){b.setAnimation(null);return}}for(a=0;a<this.polygons.length;a++)if(b=this.polygons[a],b.data.uri==c){b.setOptions({strokeColor:"#CA2251",fillColor:"#CA2251"});return}for(a=0;a<this.polylines.length;a++)if(b=this.polylines[a],b.data.uri==c){b.setOptions({strokeColor:"#CA2251",fillColor:"#CA2251"});break}};this.displayResults=function(){$(".result-odd").remove();$(".result-even").remove();$(".result-highlight").remove();$(".noSearchResults").remove();var c=0;if(0==this.results.length)0>=this.taggedRecords.length&&
!this.mapLoading&&$("#resultsBox").append('<div class="noSearchResults">No results for the <b>"'+($("#searchInput").val()==this.labels.searchInput?"":$("#searchInput").val())+'"</b> search keywords and for this this.map region and selected filters. <br /><br />You can try zooming-out the this.map to get this.results elsewhere in the city.</div>');else{this.templatesData=[];for(var a=0;a<this.results.length;a++)if(!(0<=this.taggedRecords.indexOf(this.results[a].uri))){for(var f=this.results[a].resultset,
h={},e=0;e<f.predicate.length;e++)for(var d in f.predicate[e])void 0!=f.predicate[e][d].uri?h[d.replace(":","_").replace(/[^A-Za-z0-9_-]/g,"-")]=f.predicate[e][d].uri:h[d.replace(":","_").replace(/[^A-Za-z0-9_-]/g,"-")]=f.predicate[e][d];this.templatesData.push(h);f=!1;for(e=0;e<this.taggedRecords.length;e++)if(this.taggedRecords[e].uri==this.results[a].uri){f=!0;break}if(!f){c++;0==a%2?$("#resultsBox").append('<div id="result_'+a+'" class="result-even"></div>'):$("#resultsBox").append('<div id="result_'+
a+'" class="result-odd"></div>');$("#result_"+a).append('<table class="resultTable"><tr><td id="result_column_left_'+a+'" class="resultLeftColumn"></td><td id="result_column_image_'+a+'" class="resultImageColumn"></td><td id="result_column_center_'+a+'"  class="resultCenterColumn"></td><td id="result_column_right_'+a+'" class="resultRightColumn"></td></tr></div>');null!=$.cookie("webmap-resultsperpage")&&(this.mapResultsPerPage=$.cookie("webmap-resultsperpage"));$("#result_column_left_"+a).append(c+
this.currentResultsetPage*this.mapResultsPerPage+". ");""!=this.results[a].markerImageUrl?($("#result_column_image_"+a).attr("title",this.results[a].typePrefLabel),$("#result_column_image_"+a).append('<img src="'+this.results[a].markerImageUrl+'" />')):""!=this.results[a].polygonColor?($("#result_column_image_"+a).attr("title",this.results[a].typePrefLabel),$("#result_column_image_"+a).append('<div id="result_column_canvas_'+a+'" style="top:-3px;left:20px;position:relative;width:60px;height:30px;"></div>'),
f=new jsGraphics(document.getElementById("result_column_canvas_"+a)),e=new jsColor(this.results[a].polygonColor.replace("0x","#")),f.fillPolygon(e,[new jsPoint(3,5),new jsPoint(11,6),new jsPoint(17,9),new jsPoint(15,17),new jsPoint(12,21),new jsPoint(17,22),new jsPoint(21,27),new jsPoint(15,31),new jsPoint(6,28),new jsPoint(1,25),new jsPoint(-1,14)])):""!=this.results[a].polylineColor?($("#result_column_image_"+a).attr("title",this.results[a].typePrefLabel),$("#result_column_image_"+a).append('<div id="result_column_canvas_'+
a+'" style="top:-3px;left:20px;position:relative;width:60px;height:30px;"></div>'),f=new jsGraphics(document.getElementById("result_column_canvas_"+a)),e=new jsColor(this.results[a].polylineColor.replace("0x","#")),e=new jsPen(e,2),f.drawPolyline(e,[new jsPoint(2,2),new jsPoint(13,8),new jsPoint(5,17),new jsPoint(19,18)])):($("#result_column_image_"+a).attr("title",this.results[a].typePrefLabel),$("#result_column_image_"+a).append('<img src="'+this.defaultMarkerUrl+'" />'));if(this.isAdmin){var f=
"",g;for(g in this.templatesData[a])f+=g+" = "+this.templatesData[a][g].replace(/"/,"").replace(/'/,"")+"\\n";$("#result_column_right_"+a).append('<img title="See record data (used for templating purposes)" src="'+this.imagesFolder+'application_form_edit.png" onclick="alert(\''+f+'\');" style="cursor:pointer; padding-right: 3px;" />')}this.enableRecordSelection&&($("#result_column_right_"+a).append('<input type="checkbox" name="result_checkbox_'+a+'" id="result_checkbox_'+a+'" title="Persist this result">'),
$("#result_column_right_"+a+" > input").click(function(){var a=this.parentNode.id.substring(this.parentNode.id.lastIndexOf("_")+1);b.tagRecord(this,b.results[a].uri)}),this.displayHelpTipsHover("result_checkbox_"+a,"Persist result on map","s"));void 0!=templates[this.results[a].type]?($("#result_column_center_"+a).append(templates[this.results[a].type]),"undefined"!=typeof templatesDirectives&&void 0!=templatesDirectives[this.results[a].type]?$("#result_column_center_"+a+" > div").autoRender(h,templatesDirectives[this.results[a].type]):
$("#result_column_center_"+a+" > div").autoRender(h),$("#result_column_center_"+a+" > div a[href='']").remove(),$("#result_column_center_"+a+" > div img[src='']").remove(),$("#result_column_center_"+a).find(".resultTitle").data("id",a),$("#result_column_center_"+a).find(".resultTitle").click(function(){b.enableRecordDisplayOverlay?b.openRecordDescriptionOverlay($(this).data("id"),!1):window.open(b.taggedResults[$(this).data("id")].uri,"_blank")})):($("#result_column_center_"+a).append('<div class="resultTitle"><a>'+
this.results[a].prefLabel+"</a></div>"),$("#result_column_center_"+a).append('<div class="resultDescription">'+this.results[a].description+"</div>"),$("#result_column_center_"+a+" > div > a").click(function(){var a=this.parentNode.parentNode.id.substring(this.parentNode.parentNode.id.lastIndexOf("_")+1);b.enableRecordDisplayOverlay?b.openRecordDescriptionOverlay(a,!1):window.open(b.taggedResults[a].uri,"_blank")}));$("#result_"+a).mouseover(function(){var a=this.id.substring(this.id.lastIndexOf("_")+
1);b.recordOver(b.results[a].uri)}).mouseout(function(){var a=this.id.substring(this.id.lastIndexOf("_")+1);b.recordOut(b.results[a].uri)})}}$("#webMapResults").scrollTo(0);$("#webMapFilters").scrollTo(0)}};this.tagRecord=function(c,a){$(".tipsy").remove();this.recordOut(a);var f="added";if(void 0!=c.checked)if(c.checked){var h=c.name.substring(c.name.lastIndexOf("_")+1);$("#result_"+h).remove();this.renumberResults();-1==this.taggedRecords.indexOf(a)&&this.taggedRecords.push(a)}else{if(-1!=this.taggedRecords.indexOf(a)){this.taggedRecords.splice(this.taggedRecords.indexOf(a),
1);for(f=0;f<this.taggedResults.length;f++)if(this.taggedResults[f].uri==a){this.taggedResults.splice(f,1);break}f="removed"}}else this.taggedRecords.push(a);this.enableFocusWindows&&("added"==f?this.focusMapsTaggedRecords[this.selectedFocusMapID].push(a):this.focusMapsTaggedRecords[this.selectedFocusMapID].splice(this.focusMapsTaggedRecords[this.selectedFocusMapID].indexOf(a),1));if("added"==f){h=!1;for(f=0;f<this.results.length;f++)if(this.results[f].uri==a){h=!0;break}if(h)this.taggedResults.push(this.results[f]);
else{unparsedResultset=$.ajax({type:"GET",url:this.structWSFAddress.replace(/\/+$/,"")+"/crud/read/?uri="+this.urlencode(a),dataType:"json",async:!1}).responseText;f=(new Resultset(JSON.parse(unparsedResultset))).getSubject(a);htmlSubject=this.getResultDefinition(f);this.taggedResults.push(htmlSubject);for(var h=!1,e=0;e<this.markers.length;e++){var d=this.markers[e];if(d.data.uri==f.uri&&(h=!0,d.setVisible(!0),!this.enableFocusWindows))break}if(!h&&(e=f.getPredicateValues("http://www.w3.org/2003/01/geo/wgs84_pos#lat"),
d=f.getPredicateValues("http://www.w3.org/2003/01/geo/wgs84_pos#long"),1==e.length&&1==d.length)){for(var g="",j=0;j<this.schemas.length;j++){var l=this.schemas[j].getType(f.type);if(null!=l&&void 0!=l.mapMarkerImageUrl&&null!=l.mapMarkerImageUrl){g=l.mapMarkerImageUrl[0];break}}""==g&&""!=this.defaultMarkerUrl&&(g=this.defaultMarkerUrl);e=""!=g?{icon:g,position:new google.maps.LatLng(e[0],d[0]),map:-1==this.selectedFocusMapID?this.map:this.focusMaps[this.selectedFocusMapID-1].map,title:this.stripHtml(f.getPrefLabel())}:
{position:new google.maps.LatLng(e[0],d[0]),map:-1==this.selectedFocusMapID?this.map:this.focusMaps[this.selectedFocusMapID-1].map,title:this.stripHtml(f.getPrefLabel())};d=new google.maps.Marker(e);d.data=f;google.maps.event.addListener(d,"mouseover",function(){b.featureOver(this.data.uri)});this.markers.push(d)}if(!h){for(var q=0;q<this.polygons.length;q++)g=this.polygons[q],g.data.uri==f.uri&&(h=!0,g.setMap(-1==this.selectedFocusMapID?this.map:this.focusMaps[this.selectedFocusMapID].map));if(!h)for(var d=
f.getPredicateValues("http://purl.org/ontology/sco#polygonCoordinates"),o=null,e=0;e<d.length;e++){for(var g=d[e].split(" "),n=[],m=new google.maps.LatLngBounds,j=0;j<g.length;j++)l=g[j],l=l.split(","),n.push(new google.maps.LatLng(l[1],l[0])),m=m.extend(new google.maps.LatLng(l[1],l[0])),null==o&&(o=new google.maps.LatLng(l[1],l[0]));g=new google.maps.Polygon({paths:n,strokeColor:"#CA2251",strokeOpacity:0.7,strokeWeight:2,fillColor:"#CA2251",fillOpacity:0.05});g.data=f;g.bounds=m;j=document.createElement("div");
j.style.cssText="border: 1px solid #E48E1A; margin-top: 8px; background: #E48E1A; padding: 5px; color: black;";j.innerHTML=f.getPrefLabel();j={content:j,disableAutoPan:!1,maxWidth:0,pixelOffset:new google.maps.Size(-140,0),zIndex:null,boxStyle:{background:"",opacity:0.75,width:"150px"},closeBoxMargin:"10px 2px 2px 2px",closeBoxURL:"",infoBoxClearance:new google.maps.Size(1,1),isHidden:!0,pane:"floatPane",enableEventPropagation:!1,position:o};j=new InfoBox(j);j.open(-1==this.selectedFocusMapID?this.map:
this.focusMaps[this.selectedFocusMapID].map);g.infobox=j;google.maps.event.addListener(g,"mouseout",function(){this.infobox.hide()});google.maps.event.addListener(g,"mouseover",function(){this.infobox.show();b.featureOver(this.data.uri)});this.polygons.push(g);g.setMap(-1==this.selectedFocusMapID?this.map:this.focusMaps[this.selectedFocusMapID].map)}}if(!h){for(e=0;e<this.polylines.length;e++)d=this.polylines[e],d.data.uri==f.uri&&(h=!0,d.setMap(-1==this.selectedFocusMapID?this.map:this.focusMaps[this.selectedFocusMapID].map));
if(!h){h=f.getPredicateValues("http://purl.org/ontology/sco#polylineCoordinates");for(e=0;e<h.length;e++){g=h[e].split(" ");d=[];m=new google.maps.LatLngBounds;for(j=0;j<g.length;j++)l=g[q],l=l.split(","),d.push(new google.maps.LatLng(l[1],l[0])),m=m.extend(new google.maps.LatLng(l[1],l[0])),null==o&&(o=new google.maps.LatLng(l[1],l[0]));d=new google.maps.Polyline({path:d,strokeColor:"#CA2251",strokeOpacity:0.7,strokeWeight:2,fillColor:"#CA2251",fillOpacity:0.05});d.data=f;d.bounds=m;j=document.createElement("div");
j.style.cssText="border: 1px solid #E48E1A; margin-top: 8px; background: #E48E1A; padding: 5px; color: black;";j.innerHTML=f.getPrefLabel();j={content:j,disableAutoPan:!1,maxWidth:0,pixelOffset:new google.maps.Size(-140,0),zIndex:null,boxStyle:{background:"",opacity:0.75,width:"150px"},closeBoxMargin:"10px 2px 2px 2px",closeBoxURL:"",infoBoxClearance:new google.maps.Size(1,1),isHidden:!0,pane:"floatPane",enableEventPropagation:!1,position:o};j=new InfoBox(j);j.open(-1==this.selectedFocusMapID?this.map:
this.focusMaps[this.selectedFocusMapID].map);d.infobox=j;google.maps.event.addListener(d,"mouseout",function(){this.infobox.hide()});google.maps.event.addListener(d,"mouseover",function(){this.infobox.show();b.featureOver(this.data.uri)});this.polylines.push(d);d.setMap(-1==this.selectedFocusMapID?this.map:this.focusMaps[this.selectedFocusMapID].map)}}}}}this.renumberResults();this.displayResults();this.displayTaggedRecords(this.taggedResults)};this.renumberResults=function(){for(var c=1,a=0;128>
a;a++)0<$("#result_column_left_"+a).length&&($("#result_column_left_"+a).text(c+". "),c++)};this.highlightTaggedResult=function(c){$("#webMapResults").find("*").removeClass("result-highlight");for(var a=0;a<this.taggedRecords.length;a++)if(a==c){$("#tagged_result_"+a).addClass("result-highlight");break}};this.highlightResult=function(c){$("#webMapResults").find("*").removeClass("result-highlight");for(var a=0;a<this.results.length;a++)a==c?$("#result_"+a).addClass("result-highlight"):0==a%2?$("#result_"+
a).addClass("result-even"):$("#result_"+a).addClass("result-odd")};this.displayResultsPagination=function(c,a){c<=this.mapResultsPerPage?$("#resultsPaginator").hide():($("#resultsPaginator").show(),this.currentResultsetPage=a);$("#resultsPaginator").pagination(c,{items_per_page:this.mapResultsPerPage,num_display_entries:7,num_edge_entries:1,current_page:a,callback:this.handlePaginationClick});null==$.cookie("webmap-resultsperpage")?$.cookie("webmap-resultsperpage",20,{expires:365,path:"/"}):this.mapResultsPerPage=
$.cookie("webmap-resultsperpage");var f='<select style="float:right; margin-right: 10px;">',f=20==this.mapResultsPerPage?f+'<option value="20" selected>20</option>':f+'<option value="20">20</option>',f=50==this.mapResultsPerPage?f+'<option value="50" selected>50</option>':f+'<option value="50">50</option>',f=100==this.mapResultsPerPage?f+'<option value="100" selected>100</option>':f+'<option value="100">100</option>',f=200==this.mapResultsPerPage?f+'<option value="200" selected>200</option>':f+'<option value="200">200</option>';
$("#resultsPaginator").append(f+"</select>");$("#resultsPaginator > select").change(function(){b.changeResultsPerPage(this)})};this.changeResultsPerPage=function(c){this.mapResultsPerPage=c.value;$.cookie("webmap-resultsperpage",c.value,{expires:365,path:"/"});this.search()};this.handlePaginationClick=function(c){this.current_page!=c&&(b.currentResultsetPage=c,b.search());return!1};this.displayFiltersDataset=function(){$(".webMapFiltersTitleDataset").remove();$(".webMapFiltersDataset").remove();var c=
"";0<$("#searchDatasetFilterForm").length&&(c=$("#quicksearchinput_filterdatasets").val(),$("#searchDatasetFilterForm").remove());if(0<this.filtersDatasets.length){$("#webMapFilters").append('<div id="webMapFiltersTitleDataset" class="webMapFiltersTitleDataset">'+this.labels.sourcesFilterSectionHeader+"</div>");this.displayHelpTipsHover("webMapFiltersTitleDataset","Filter results by their provenance","e");$("#webMapFilters").append('<form method="get" id="searchDatasetFilterForm"><div style="padding-bottom: 5px;"><img src="'+
this.imagesFolder+'magnifier.png" style="position: relative; top: 4px; left: 3px"> <input type="text" value="" name="q" id="quicksearchinput_filterdatasets" style="margin-left: 4px" autocomplete="off" /></div></form>');this.displayHelpTipsHover("searchDatasetFilterForm","Filter displayed sources","e");$("#webMapFilters").append('<div id="webMapFiltersDataset" class="webMapFiltersDataset"></div>');for(var a=0;a<this.filtersDatasets.length;a++)$("#webMapFiltersDataset").append('<div id="filter_dataset_'+
a+'" class="webMapFiltersDatasetItem"></div>'),this.displayHelpTipsHover("filter_dataset_"+a,'Only shows result in "'+this.filtersDatasets[a].prefLabel+'"',"e"),-1!=this.checkedFiltersDatasets.indexOf(this.filtersDatasets[a].uri)?$("#filter_dataset_"+a).append('<label><input class="datasetCheckbox" type="checkbox" name="filter_dataset_checkbox_'+a+'" id="filter_dataset_checkbox_'+a+'" title="Only display results from that source" checked>'+this.filtersDatasets[a].prefLabel+(0==this.filtersDatasets[a].nbRecords?
"":" ("+this.filtersDatasets[a].nbRecords+")")+"</label>"):$("#filter_dataset_"+a).append('<label><input class="datasetCheckbox" type="checkbox" name="filter_dataset_checkbox_'+a+'" id="filter_dataset_checkbox_'+a+'" title="Only display results from that source">'+this.filtersDatasets[a].prefLabel+(0==this.filtersDatasets[a].nbRecords?"":" ("+this.filtersDatasets[a].nbRecords+")")+"</label>"),$("#filter_dataset_checkbox_"+a).click(function(){b.datasetFilterCheck(this)}),$("#filter_dataset_"+a).mouseover(function(){$(this).css("font-weight",
"bold")}),$("#filter_dataset_"+a).mouseout(function(){$(this).css("font-weight","normal")});$("#quicksearchinput_filterdatasets").quicksearch("div#webMapFiltersDataset div");$("#quicksearchinput_filterdatasets").val(c);$("#quicksearchinput_filterdatasets").keyup()}};this.datasetFilterCheck=function(c){$(".tipsy").remove();var a=c.name.substring(c.name.lastIndexOf("_")+1);this.enableFocusWindows&&(this.focusMapsResults={1:null,2:null,3:null});c.checked?(this.checkedFiltersDatasets.push(this.filtersDatasets[a].uri),
this.currentResultsetPage=this.nbResults=0,this.session.fd=this.checkedFiltersDatasets):(this.removeByElement(this.checkedFiltersDatasets,this.filtersDatasets[a].uri),0==this.checkedFiltersDatasets.length&&(this.session.fd=[]),this.currentResultsetPage=this.nbResults=0);this.search()};this.displayFiltersType=function(){$(".webMapFiltersTitleType").remove();$(".webMapFiltersType").remove();var c="";0<$("#searchTypeFilterForm").length&&(c=$("#quicksearchinput_filtertypes").val(),$("#searchTypeFilterForm").remove());
if(0<this.filtersTypes.length){$("#webMapFilters").append('<div id="webMapFiltersTitleType" class="webMapFiltersTitleType">'+this.labels.typesFilterSectionHeader+"</div>");this.displayHelpTipsHover("webMapFiltersTitleType","Filter results by their kind","e");$("#webMapFilters").append('<form method="get" id="searchTypeFilterForm"><div style="padding-bottom: 5px;"><img src="'+this.imagesFolder+'magnifier.png" style="position: relative; top: 4px; left: 3px"> <input type="text" value="" name="q" id="quicksearchinput_filtertypes" style="margin-left: 4px" autocomplete="off" /></div></form>');
this.displayHelpTipsHover("searchTypeFilterForm","Filter displayed kinds","e");$("#webMapFilters").append('<div id="webMapFiltersType" class="webMapFiltersType"></div>');for(var a=0;a<this.filtersTypes.length;a++){for(var f=!1,d=0;d<this.schemas.length;d++){var e=this.schemas[d].getType(this.filtersTypes[a].uri);if(null!=e){void 0!=e.ignoredBy&&"http://purl.org/ontology/sco#sWebMap"==e.ignoredBy[0]&&(f=!0);break}}if(!f&&($("#webMapFiltersType").append('<div id="filter_type_'+a+'" class="webMapFiltersTypeItem"></div>'),
this.displayHelpTipsHover("filter_type_"+a,'Only shows result of kind "'+this.filtersTypes[a].prefLabel+'"',"e"),0<this.filtersTypes[a].nbRecords||-1!=this.checkedFiltersTypes.indexOf(this.filtersTypes[a].uri)))-1!=this.checkedFiltersTypes.indexOf(this.filtersTypes[a].uri)?$("#filter_type_"+a).append('<label><input class="typeCheckbox" type="checkbox" name="filter_type_checkbox_'+a+'" id="filter_type_checkbox_'+a+'" title="Only display results of that kind" checked>'+this.filtersTypes[a].prefLabel+
(0==this.filtersTypes[a].nbRecords||!1==this.displayTypeFiltersCounts?"":" ("+this.filtersTypes[a].nbRecords+")")+"</label>"):$("#filter_type_"+a).append('<label><input class="typeCheckbox" type="checkbox" name="filter_type_checkbox_'+a+'" id="filter_type_checkbox_'+a+'" title="Only display results of that kind">'+this.filtersTypes[a].prefLabel+(0==this.filtersTypes[a].nbRecords||!1==this.displayTypeFiltersCounts?"":" ("+this.filtersTypes[a].nbRecords+")")+"</label>"),$("#filter_type_checkbox_"+a).click(function(){b.typeFilterCheck(this)}),
$("#filter_type_"+a).mouseover(function(){$(this).css("font-weight","bold")}),$("#filter_type_"+a).mouseout(function(){$(this).css("font-weight","normal")})}$("#quicksearchinput_filtertypes").quicksearch("div#webMapFiltersType div");$("#quicksearchinput_filtertypes").val(c);$("#quicksearchinput_filtertypes").keyup()}};this.typeFilterCheck=function(c){$(".tipsy").remove();var a=c.name.substring(c.name.lastIndexOf("_")+1);this.enableFocusWindows&&(this.focusMapsResults={1:null,2:null,3:null});c.checked?
(this.checkedFiltersTypes.push(this.filtersTypes[a].uri),this.currentResultsetPage=this.nbResults=0,this.session.ft=this.checkedFiltersTypes):(this.removeByElement(this.checkedFiltersTypes,this.filtersTypes[a].uri),0==this.checkedFiltersTypes.length&&(this.session.ft=[]),this.currentResultsetPage=this.nbResults=0);this.search()};this.displayFiltersAttribute=function(){$(".webMapFiltersTitleAttribute").remove();$(".webMapFiltersAttribute").remove();$(".webMapFiltersInputContainer").remove();if(0<$("#searchAttributeFilterForm").length){var c=
$("#quicksearchinput_filterattributes").val();$("#searchAttributeFilterForm").remove()}if(0<this.filtersAttributes.length){$("#webMapFilters").append('<div id="webMapFiltersTitleAttribute" class="webMapFiltersTitleAttribute">'+this.labels.attributesFilterSectionHeader+"</div>");this.displayHelpTipsHover("webMapFiltersTitleAttribute","Filter results by their attributes","e");$("#webMapFilters").append('<div id="webMapFiltersInputContainer" class="webMapFiltersInputContainer"></div>');$("#webMapFilters").append('<form method="get" id="searchAttributeFilterForm"><div style="padding-bottom: 5px;"><img src="'+
this.imagesFolder+'magnifier.png" style="position: relative; top: 4px; left: 3px"> <input type="text" value="" name="q" id="quicksearchinput_filterattributes" style="margin-left: 4px" autocomplete="off" /></div></form>');this.displayHelpTipsHover("searchAttributeFilterForm","Filter displayed attributes","e");$("#webMapFilters").append('<div id="webMapFiltersAttribute" class="webMapFiltersAttribute"></div>');for(var a=0;a<this.filtersAttributes.length;a++){for(var f=!1,d=0;d<this.schemas.length;d++){var e=
this.schemas[d].getAttribute(this.filtersAttributes[a].uri);if(null!=e){void 0!=e.ignoredBy&&"http://purl.org/ontology/sco#sWebMap"==e.ignoredBy[0]&&(f=!0);break}}if(!f&&(0<this.filtersAttributes[a].nbRecords||-1!=this.checkedFiltersAttributes.indexOf(this.filtersAttributes[a].uri)))$("#webMapFiltersAttribute").append('<div id="filter_attribute_'+a+'" class="webMapFiltersAttributeItem"></div>'),void 0==this.attributeValueFilters[this.filtersAttributes[a].uri]?($("#filter_attribute_"+a).append('<img id="attributeFilterImage_'+
a+'" class="attributeFilterImage" src="'+this.imagesFolder+'magnifier_zoom_in.png" title="Add a value to filter by" />'),this.displayHelpTipsHover("filter_attribute_"+a,'Shows results that have a certain value for the "'+this.filtersAttributes[a].prefLabel+'" attribute',"e"),$("#attributeFilterImage_"+a).click(function(){var a=this.id.substring(this.id.lastIndexOf("_")+1);b.addFilterValue(a)})):($("#filter_attribute_"+a).append('<img id="attributeFilterImage_'+a+'" class="attributeFilterImage" src="'+
this.imagesFolder+'magifier_zoom_out.png" title="Remove the value filter for that attribute" />'),this.displayHelpTipsHover("filter_attribute_"+a,"Remove this attribute/value filter","e"),$("#attributeFilterImage_"+a).click(function(){var a=this.id.substring(this.id.lastIndexOf("_")+1);b.removeAttributeValueFilter(a)})),-1!=this.checkedFiltersAttributes.indexOf(this.filtersAttributes[a].uri)?$("#filter_attribute_"+a).append('<span id="attributeFilterCheckboxText_'+a+'">'+this.filtersAttributes[a].prefLabel+
" = <b>"+this.attributeValueFilters[this.filtersAttributes[a].uri]+"</b> "+(0==this.filtersAttributes[a].nbRecords||!1==this.displayAttributeFiltersCounts?"":" ("+this.filtersAttributes[a].nbRecords+")")+"</span>"):$("#filter_attribute_"+a).append('<span id="attributeFilterCheckboxText_'+a+'">'+this.filtersAttributes[a].prefLabel+(0==this.filtersAttributes[a].nbRecords||!1==this.displayAttributeFiltersCounts?"":" ("+this.filtersAttributes[a].nbRecords+")")+"</span>"),$("#attributeFilterCheckboxText_"+
a).mouseover(function(){$(this).css("font-weight","bold")}),$("#attributeFilterCheckboxText_"+a).mouseout(function(){$(this).css("font-weight","normal")}),$("#attributeFilterCheckboxText_"+a).data("i",a),$("#attributeFilterCheckboxText_"+a).click(function(){var a=$(this).data("i");void 0==this.attributeValueFilters[this.filtersAttributes[a].uri]?this.addFilterValue(a):this.removeAttributeValueFilter(a)})}$("#quicksearchinput_filterattributes").quicksearch("div#webMapFiltersAttribute div");$("#quicksearchinput_filterattributes").val(c);
$("#quicksearchinput_filterattributes").keyup()}};this.displaySearch=function(){$("#webMapSearch").append('<table width="100%"><tr><td width="100%"><div class="searchMapWrapper"><div class="inputMapWrapper"><input type="text" maxlength="2048" id="searchInput" class="searchBox" value="Search Map" style="font-style: italic" /></div></div></td><td width="0%"><div class="searchButtonMapWrapper"><input type="submit" class="searchButton" value=""></div></td></tr></table>');$(".searchBox").val(this.labels.searchInput);
$(".searchButton").val(this.labels.searchButton);$(".searchButton").click(function(){b.search()});$("#searchInput").focus(function(){$(this).val()==b.labels.searchInput&&($(this).val(""),$(this).css("font-style","normal"))});$("#searchInput").blur(function(){""==$(this).val()&&($(this).val(b.labels.searchInput),$(this).css("font-style","italic"))});$("#searchInput").keypress(function(c){return b.submitSearchEnter(this,c)});$("#searchInput").tipsy({fade:!0,gravity:"s",title:function(){return"Search for something specific"}});
this.enableSessions&&(0>=this.getSessions().length?$("#selectMapDiv").hide():$("#selectMapDiv").show())};this.clearMap=function(){this.checkedFiltersDatasets=[];this.checkedFiltersTypes=[];this.checkedFiltersAttributes=[];this.hideUntaggedRecords();this.displayResultsPagination(0,0);this.results=[];this.displayResults();this.filtersAttributes=[];this.filtersTypes=[];this.filtersDatasets=[];this.attributeValueFilters={};this.displayFiltersAttribute();this.displayFiltersType();this.displayFiltersDataset()};
this.loadMap=function(c){this.startWaiting();this.mapLoading=!0;$("#searchInput").val(this.labels.searchInput);""!=this.googleUrlShortenerKey&&""!=this.sharedMapUrl&&$("#linkButtonDiv").hide();$("#deleteButtonDiv").hide();$("#importBox").is(":hidden")||$("#mapSessionsPanel").fadeOut("slow",function(){});this.taggedRecords=[];this.taggedResults=[];$("#taggedRecordsBox").empty();this.clearMap();var a;void 0==c.notes?(c=$(c).children(":first").get(0),0!=c.selectedIndex&&(this.selectedMapId=c.value,a=
this.getSessions()[parseInt(c.value)])):a=c;void 0==a.fwe&&(a.fwe=!1);if(a.fwe!=this.enableFocusWindows)if(-1==window.location.toString().indexOf("?"))window.location=window.location.toString()+"?map="+escape(JSON.stringify(a));else if(-1==window.location.toString().indexOf("map="))window.location=window.location.toString()+"&map="+escape(JSON.stringify(a));else{var c=window.location.toString().indexOf("map="),b=window.location.toString().indexOf("&",c+1),d="",d=-1==b?window.location.toString().substring(0,
c):window.location.toString().substring(0,c)+window.location.toString().substring(b);window.location=d+"map="+escape(JSON.stringify(a))}""!=this.googleUrlShortenerKey&&""!=this.sharedMapUrl&&$("#linkButtonDiv").show();$("#deleteButtonDiv").show();google.maps.event.trigger(this.map,"resize");this.map.setZoom(this.map.getZoom());this.checkedFiltersDatasets=a.fd;this.checkedFiltersTypes=a.ft;this.checkedFiltersAttributes=a.fa;this.attributeValueFilters=a.av;$("#searchInput").val(a.q);this.session=a;
""!=a.notes&&($("#mapSessionsMessagePanel").empty(),$("#mapSessionsMessagePanel").append('<table style="margin: 20px;"><tbody style="border: none;"><tr><td><h2 style="margin: 0px;">Notes:</h2><br />'+this.session.notes+"</td></tr></tbody></table>"),$("#mapSessionsMessagePanel").fadeIn("slow",function(){}));if(a.fwe){c=new google.maps.LatLngBounds;c=c.extend(new google.maps.LatLng(a.f1.nelat,a.f1.nelng));c=c.extend(new google.maps.LatLng(a.f1.swlat,a.f1.swlng));this.focusMaps[0].map.fitBounds(c);this.focusMaps[0].map.setZoom(a.f1.z);
c=new google.maps.LatLngBounds;c=c.extend(new google.maps.LatLng(a.f2.nelat,a.f2.nelng));c=c.extend(new google.maps.LatLng(a.f2.swlat,a.f2.swlng));this.focusMaps[1].map.fitBounds(c);this.focusMaps[0].map.setZoom(a.f2.z);c=new google.maps.LatLngBounds;c=c.extend(new google.maps.LatLng(a.f3.nelat,a.f3.nelng));c=c.extend(new google.maps.LatLng(a.f3.swlat,a.f3.swlng));this.focusMaps[2].map.fitBounds(c);this.focusMaps[0].map.setZoom(a.f3.z);if(0<a.f1.r.length){google.maps.event.trigger(this.focusMaps[0].map,
"click");for(c=0;c<a.f1.r.length;c++)this.tagRecord({},a.f1.r[c]);this.clearMap()}if(0<a.f2.r.length){google.maps.event.trigger(this.focusMaps[1].map,"click");for(c=0;c<a.f2.r.length;c++)this.tagRecord({},a.f2.r[c]);this.clearMap()}if(0<a.f3.r.length){google.maps.event.trigger(this.focusMaps[2].map,"click");for(c=0;c<a.f3.r.length;c++)this.tagRecord({},a.f3.r[c]);this.clearMap()}google.maps.event.trigger(this.focusMaps[a.sfw-1].map,"click");this.selectedFocusMapID=a.sfw;this.clearMap()}else for(c=
0;c<a.records.length;c++)this.tagRecord({},a.records[c]);c=!1;if(a.fwe){if(0<a.f1.r.length||0<a.f2.r.length||0<a.f3.r.length)c=!0}else 0<a.records.length&&(c=!0);c?(this.forceSearch&&this.search(),this.zoomToTaggedRecords()):this.search();this.mapLoading=!1;this.stopWaiting()};this.initializeMap=function(){this.session=this.initializationSession;void 0!=this.session.sfw&&(this.selectedFocusMapID=this.session.sfw);this.checkedFiltersDatasets=this.initializationSession.fd;this.checkedFiltersTypes=this.initializationSession.ft;
for(var c=0;c<this.initializationSession.records.length;c++)this.tagRecord({},this.initializationSession.records[c]);0>=this.initializationSession.records.length?this.search():(this.forceSearch&&this.search(),0<this.inclusionRecords.length&&($("#inclusionButtonDiv").show(),this.zoomToTaggedRecords()))};this.deleteMap=function(){var c=this.getSessions();c.splice(this.selectedMapId,1);for(var a=0;256>a;a++)null!=$.cookie("webmap-session-"+a)&&$.cookie("webmap-session-"+a,null);for(a=0;a<c.length;a++)$.cookie("webmap-session-"+
a,JSON.stringify(c[a]),{expires:365,path:"/"});this.refreshMapSessionsList()};this.refreshMapSessionsList=function(){""!=this.googleUrlShortenerKey&&""!=this.sharedMapUrl&&$("#linkButtonDiv").hide();$("#deleteButtonDiv").hide();$("#mapsList").empty();$("#mapsList").append(this.getMapsListBoxOptions());0>=this.getSessions().length?$("#selectMapDiv").hide():$("#selectMapDiv").show()};this.getMapsListBoxOptions=function(){var c=this.getSessions(),a='<option value="0" selected>'+this.labels.loadSavedMapSessionInput+
"</option>";if(0<c.length)for(i=0;i<c.length;i++)a+='<option value="'+i+'">'+c[i].name+"</option>";return a};this.getSessions=function(){for(var c=[],a=0;256>a&&!(null==$.cookie("webmap-session-"+a));a++)c.push(JSON.parse($.cookie("webmap-session-"+a)));return c};this.saveMapPanel=function(){$("#mapSessionsPanel").is(":hidden")?$("#mapSessionsPanel").fadeIn("slow",function(){$("#mapSessionsPanel").empty();$("#mapSessionsPanel").append('<table style="padding-top: 20px;"><tbody style="border: none;"><tr><td style="padding-left: 20px;">session name:</td><td style="padding-right: 15px;"><input style="width: 100%" type="text" id="saveNameInput" /></td></tr><tr><td style="padding-left: 20px;">Notes:</td><td style="padding-right: 15px;"><textarea style="width: 100%" id="saveNotesInput" /></td></tr><tr><td colspan="2" align="center" style="padding-right: 15px;"><button id="saveSessionButton">Save session</button></td></tr></tbody></table>');
$("#saveSessionButton").click(function(){b.saveMap()})}):$("#mapSessionsPanel").fadeOut("slow",function(){})};this.linkMapPanel=function(){$("#mapSessionsPanel").is(":hidden")?$("#mapSessionsPanel").fadeIn("slow",function(){$("#mapSessionsPanel").empty();var c=b.getSessions(),a=b.sharedMapUrl,a=a+("?map="+escape(JSON.stringify(c[b.selectedMapId])));gapi.client.setApiKey(b.googleUrlShortenerKey);gapi.client.load("urlshortener","v1",function(){gapi.client.urlshortener.url.insert({resource:{longUrl:a}}).execute(function(a){a.error?
$("#mapSessionsPanel").append('<table style="margin-top: 20px; margin-bottom: 20px;"><tbody style="border: none"><tr><td align="center">URL to this map session page: <input size="60" type="text" id="linkInput" value="Error: '+a.error.message+'" /></td></tr></tbody></table>'):($("#mapSessionsPanel").append('<table style="margin-top: 20px; margin-bottom: 20px;"><tbody style="border: none"><tr><td align="center">URL to this map session page: <input size="60" type="text" id="linkInput" value="'+a.id+
'" /></td></tr></tbody></table>'),$("#linkInput").focus(function(){this.select()}))})})}):$("#mapSessionsPanel").fadeOut("slow",function(){})};this.get_hostname=function(c){return(c=((c||"")+"").match(/^http:\/\/[^/]+/))?c[0]:null};this.saveMap=function(){this.session=this.enableFocusWindows?{name:$("#saveNameInput").val(),notes:$("#saveNotesInput").val(),q:$("#searchInput").val()==this.labels.searchInput?"":$("#searchInput").val(),fd:this.checkedFiltersDatasets,fa:this.checkedFiltersAttributes,ft:this.checkedFiltersTypes,
av:this.attributeValueFilters,attributes_boolean_operator:"and",fwe:!0,sfw:this.selectedFocusMapID,f1:{nelat:this.focusMaps[0].map.getBounds().getNorthEast().lat(),nelng:this.focusMaps[0].map.getBounds().getNorthEast().lng(),swlat:this.focusMaps[0].map.getBounds().getSouthWest().lat(),swlng:this.focusMaps[0].map.getBounds().getSouthWest().lng(),z:this.focusMaps[0].map.getZoom(),r:this.focusMapsTaggedRecords[1]},f2:{nelat:this.focusMaps[1].map.getBounds().getNorthEast().lat(),nelng:this.focusMaps[1].map.getBounds().getNorthEast().lng(),
swlat:this.focusMaps[1].map.getBounds().getSouthWest().lat(),swlng:this.focusMaps[1].map.getBounds().getSouthWest().lng(),z:this.focusMaps[1].map.getZoom(),r:this.focusMapsTaggedRecords[2]},f3:{nelat:this.focusMaps[2].map.getBounds().getNorthEast().lat(),nelng:this.focusMaps[2].map.getBounds().getNorthEast().lng(),swlat:this.focusMaps[2].map.getBounds().getSouthWest().lat(),swlng:this.focusMaps[2].map.getBounds().getSouthWest().lng(),z:this.focusMaps[2].map.getZoom(),r:this.focusMapsTaggedRecords[3]}}:
{name:$("#saveNameInput").val(),notes:$("#saveNotesInput").val(),q:$("#searchInput").val()==this.labels.searchInput?"":$("#searchInput").val(),fd:this.checkedFiltersDatasets,fa:this.checkedFiltersAttributes,ft:this.checkedFiltersTypes,av:this.attributeValueFilters,attributes_boolean_operator:"and",records:this.taggedRecords};$("#mapSessionsPanel").fadeOut("slow",function(){$("#saveNameInput").val("")});for(var c=0;256>c&&!(null==$.cookie("webmap-session-"+c));c++);$.cookie("webmap-session-"+c,JSON.stringify(this.session),
{expires:365,path:"/"});alert("Session Saved");this.refreshMapSessionsList()};this.submitSearchEnter=function(c,a){var b;if(window.event)b=window.event.keyCode;else if(a)b=a.which;else return!0;return 13==b?(this.search(),!1):!0};this.browse=function(){$("#searchInput").val(this.labels.searchInput);this.search()};this.removeByElement=function(c,a){for(var b=0;b<c.length;b++)c[b]==a&&c.splice(b,1)};this.addFilterValue=function(c){this.enableFocusWindows&&(this.focusMapsResults={1:null,2:null,3:null});
void 0==this.attributeValueFilters[this.filtersAttributes[c].uri]&&(this.attributeValueFilters[this.filtersAttributes[c].uri]="");$("#attributeFilterImage_"+c).attr("src",this.imagesFolder+"magnifier.png");$("#attributeFilterImage_"+c).attr("title","Add the value to filter in the input text above");$("#attributeFilterCheckboxText_"+c).hide();$("#attributeFilterCheckboxText_"+c).after('<table class="attributeFilterInputTable" id="attributeFilterInputTable_'+c+'"><tr><td>Filter:</td> <td><input class="webMapFiltersInputText" type="text" value="'+
this.attributeValueFilters[this.filtersAttributes[c].uri]+'" id="webMapFiltersInputText_'+c+'" /></td><td><span id="addButton_'+c+'"></span></td></tr></table>');$("#webMapFiltersInputText_"+c).keypress(function(a){return b.submitFilterEnter(this,a)});$("#attributeFilterInputTable_"+c).width($("#filter_attribute_"+c).width()-30);for(var a="",f=0;f<this.filtersDatasets.length;f++)0<this.checkedFiltersDatasets.length?-1!=this.checkedFiltersDatasets.indexOf(this.filtersDatasets[f].uri)&&(a=this.filtersDatasets[f].uri+
";"):a+=this.filtersDatasets[f].uri+";";a.replace(/;+$/,"");for(var d="",f=0;f<this.checkedFiltersTypes.length;f++)d=this.checkedFiltersTypes[f]+";";""==d?d="all":d.replace(/;+$/,"");attributeValueFiltersWSString="";for(var e in this.attributeValueFilters)e!=this.filtersAttributes[c].uri&&(attributeValueFiltersWSString+=this.urlencode(e)+"::"+this.urlencode(this.attributeValueFilters[e])+";");if(this.includeResultsInTargetInclusionRecords){for(f=0;f<this.inclusionRecords.length;f++)attributeValueFiltersWSString=
attributeValueFiltersWSString+this.urlencode("http://www.geonames.org/ontology#locatedIn")+"::"+this.urlencode(this.inclusionRecords[f])+";";this.session.attributes_boolean_operator=1<this.inclusionRecords.length?"or":"and"}e=this.map.getBounds();f=e.getNorthEast();e=e.getSouthWest();filterAc=$("#webMapFiltersInputText_"+c).autocomplete({serviceUrl:this.structWSFAddress+"search/",sWebMapRef:b,minChars:0,maxHeight:400,width:300,iconID:"searchButtonImage",zIndex:9999,onSelect:function(a){$("#webMapFiltersInputText_"+
c).val(a.substring(0,a.lastIndexOf(" (")))},deferRequestBy:0,params:{q:$("#searchInput").val()==this.labels.searchInput?"":$("#searchInput").val(),datasets:a,attributes:this.urlencode(this.filtersAttributes[c].uri),constrainedAttributes:attributeValueFiltersWSString,page:0,items:0,include_aggregates:"true",inference:"off",attributes_boolean_operator:this.session.attributes_boolean_operator,aggregate_attributes:this.urlencode(this.filtersAttributes[c].uri),types:d,range_filter:f.lat()+";"+f.lng()+
";"+e.lat()+";"+e.lng(),filterID:c},noCache:!1});filterAc.enable();$("#webMapFiltersInputText_"+c).focus()};this.attributeValueFilter=function(c){$(".tipsy").remove();var a=$("#webMapFiltersInputText_"+c).val();if(""==a)$("#attributeFilterInputTable_"+c).remove(),$("#attributeFilterImage_"+c).attr("src",this.imagesFolder+"magnifier_zoom_in.png"),$("#attributeFilterImage_"+c).attr("title","Add a value to filter by"),$("#attributeFilterCheckboxText_"+c).show();else{$("#attributeFilterInputTable_"+c).remove();
$("#attributeFilterCheckboxText_"+c).show();$("#attributeFilterImage_"+c).attr("src",this.imagesFolder+"magifier_zoom_out.png");$("#attributeFilterImage_"+c).attr("title","Remove the value filter for that attribute");this.attributeValueFilters[this.filtersAttributes[c].uri]=a;this.checkedFiltersAttributes.push(this.filtersAttributes[c].uri);var b=$("#attributeFilterCheckboxText_"+c).html(),d=b.substring(b.lastIndexOf("(")+1,b.lastIndexOf(")"));-1==b.lastIndexOf("=")&&(b=b.substring(0,b.lastIndexOf("(")-
1));$("#attributeFilterCheckboxText_"+c).html(b+" = "+a+(!1==this.displayAttributeFiltersCounts?"":" ("+d+")"));this.session.fa=this.filtersAttributes;this.session.av=this.attributeValueFilters;this.search()}};this.removeAttributeValueFilter=function(c){this.enableFocusWindows&&(this.focusMapsResults={1:null,2:null,3:null});$("#attributeFilterImage_"+c).attr("src",this.imagesFolder+"magnifier_zoom_in.png");$("#attributeFilterImage_"+c).attr("title","Add a value to filter by");delete this.attributeValueFilters[this.filtersAttributes[c].uri];
this.checkedFiltersAttributes.splice(this.checkedFiltersAttributes.indexOf(this.filtersAttributes[c].uri),1);delete this.checkedFiltersAttributes[this.filtersAttributes[c].uri];this.session.fa=this.checkedFiltersAttributes;this.session.av=this.attributeValueFilters;this.search()};this.getDatasetsTitles=function(){unparsedResultset=$.ajax({type:"GET",url:this.structWSFAddress.replace(/\/+$/,"")+"/dataset/read/?uri=all",dataType:"json",async:!1}).responseText;var c=new Resultset(JSON.parse(unparsedResultset)),
a={},b;for(b in c.subjects)if(c.subjects.hasOwnProperty(b)){var d=c.subjects[b],e=d.getPredicateValues("http://purl.org/dc/terms/title");a[d.uri]=e[0]}$.cookie("webmap-datasetsTitles",escape(JSON.stringify(a)),{expires:365,path:"/"});this.datasetsTitles=a};this.submitFilterEnter=function(c,a){var b;if(window.event)b=window.event.keyCode;else if(a)b=a.which;else return!0;return 13==b?(this.attributeValueFilter(c.id.substring(c.id.lastIndexOf("_")+1)),!1):!0};this.urlencode=function(c){c=(c+"").toString();
return encodeURIComponent(c).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")};this.getUrlVars=function(){for(var c=[],a,b=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),d=0;d<b.length;d++)a=b[d].split("="),c.push(a[0]),c[a[0]]=a[1];return c};this.startWaiting=function(){$.blockUI({overlayCSS:{opacity:0},message:""})};this.stopWaiting=function(){$.unblockUI()};this.displayHelpTipsHover=function(c,
a,b){$("#"+c).tipsy({fade:!0,trigger:"manual",gravity:b,title:function(){return a}});$("#"+c).mouseover(function(){$(this).tipsy("show")});$("#"+c).mouseout(function(){$(this).tipsy("hide")})};this.getResultDefinition=function(c){var a=c.getPredicateValues("http://purl.org/dc/terms/isPartOf")[0],b=c.getPredicateValues("http://www.w3.org/2003/01/geo/wgs84_pos#lat")[0],d=c.getPredicateValues("http://www.w3.org/2003/01/geo/wgs84_pos#long")[0],e="";if(void 0!=b&&void 0!=d&&0<b.length&&0<d.length)for(b=
0;b<this.schemas.length;b++)if(d=this.schemas[b].getType(c.type),null!=d&&void 0!=d.mapMarkerImageUrl&&null!=d.mapMarkerImageUrl){e=d.mapMarkerImageUrl[0];break}var g="";0<c.getPredicateValues("http://purl.org/ontology/sco#polygonCoordinates").length&&(g="0xCA2251");var s="";0<c.getPredicateValues("http://purl.org/ontology/sco#polylineCoordinates").length&&(s="0xCA2251");for(var j="",b=0;b<this.schemas.length;b++)if(d=this.schemas[b].getType(c.type),null!=d){j=d.prefLabel;break}return{uri:c.uri,type:c.type,
typePrefLabel:j,prefLabel:c.getPrefLabel(),description:c.getDescription(),prefURL:c.getPrefURL(),dataset:void 0!=a?a.uri:"",img:"",markerImageUrl:e,polygonColor:g,polylineColor:s,resultset:c}};this.SelectMapControl=function(c){$(c).append('<select id="mapsList" name="menu">'+b.getMapsListBoxOptions()+"</select>");$(c).change(function(){b.loadMap(this)})};this.SaveButtonControl=function(c){$(c).append('<input type="submit" value="'+b.labels.saveSessionButton+'" id="saveMapButtonControl">');$(c).tipsy({fade:!0,
gravity:"n",title:function(){return"Save the state of the current map"}});$(c).click(function(){b.saveMapPanel()})};this.DeleteButtonControl=function(c){$(c).append('<input type="submit" value="'+b.labels.deleteSessionButton+'" id="deleteMapButtonControl">');$(c).tipsy({fade:!0,gravity:"n",title:function(){return"Delete the current loaded map"}});$(c).click(function(){b.deleteMap()})};this.LinkButtonControl=function(c){$(c).append('<input type="submit" value="'+b.labels.shareSessionButton+'" id="shareMapButtonControl">');
$(c).tipsy({fade:!0,gravity:"n",title:function(){return"Get a link to share this map with your friends and family"}});$(c).click(function(){b.linkMapPanel()})};this.InclusionButtonControl=function(c){this.includeResultsInTargetInclusionRecords?$(c).append('<input type="submit" id="inclusionButtonInput" value="'+b.labels.inclusionRecordsButtonOff+'">'):$(c).append('<input type="submit" id="inclusionButtonInput" value="'+b.labels.inclusionRecordsButtonOn+'">');$(c).click(function(){b.toggleInclusionRecordsFilter()});
$(c).tipsy({fade:!0,gravity:"n",title:function(){return"Shows results in/out the region boundaries"}})};this.zoomToTaggedRecords=function(){for(var c=new google.maps.LatLngBounds,a=0;a<this.taggedRecords.length;a++){for(var b=0;b<this.polygons.length;b++)this.polygons[b].data.uri==this.taggedRecords[a]&&(c=c.union(this.polygons[b].bounds));for(b=0;b<this.polylines.length;b++)this.polylines[b].data.uri==this.taggedRecords[a]&&(c=c.union(this.polylines[b].bounds));for(b=0;b<this.markers.length;b++)this.markers[b].data.uri==
this.taggedRecords[a]&&(c=c.extend(this.markers[b].getPosition()))}this.map.fitBounds(c)};this.hideUntaggedRecords=function(){if(this.enableFocusWindows)var b=[];for(var a=0;a<this.markers.length;a++)0>this.taggedRecords.indexOf(this.markers[a].data.uri)?this.enableFocusWindows?this.markers[a].setMap(null):this.markers[a].setVisible(!1):this.enableFocusWindows&&b.push(this.markers[a]);this.enableFocusWindows&&(this.markers=b);for(b=0;b<this.polygons.length;b++)0>this.taggedRecords.indexOf(this.polygons[b].data.uri)&&
this.polygons[b].setMap(null);for(b=0;this.polylines<this.polylines.length;b++)0>this.taggedRecords.indexOf(this.polylines[b].data.uri)&&this.polylines[b].setMap(null)};this.toggleInclusionRecordsFilter=function(){this.includeResultsInTargetInclusionRecords?(this.includeResultsInTargetInclusionRecords=!1,$("#inclusionButtonInput").val(this.labels.inclusionRecordsButtonOff)):(this.includeResultsInTargetInclusionRecords=!0,$("#inclusionButtonInput").val(this.labels.inclusionRecordsButtonOn));this.search()};
this.openRecordDescriptionOverlay=function(c,a){var d="webMap";this.enableFocusWindows&&(d="resultsCanvas");var g=$("#"+d).position();$("#recordDescriptionOverlay").css({position:"absolute",top:g.top,left:g.left,width:$("#"+d).css("width"),height:$("#"+d).css("height")});var e="",e=a?"http://"+document.domain+"/conStruct/view/?uri="+this.urlencode(this.taggedResults[c].uri)+"&dataset="+this.urlencode(this.taggedResults[c].dataset):"http://"+document.domain+"/conStruct/view/?uri="+this.urlencode(this.results[c].uri)+
"&dataset="+this.urlencode(this.results[c].dataset),k=e+"&mime=template%2Fhtml";$("#recordDescriptionOverlay").html('<div style="width: 100%; height: 100%"><img id="recordDescriptionOverlayClose" title="Close popup" src="'+this.imagesFolder+'cross.png" style="position:relative; float: right; cursor: pointer; top: 3px; right: 3px;" /><img id="recordDescriptionOverlayOpen" title="Open in another window" src="'+this.imagesFolder+'application_double.png" style="position:relative; float: right; cursor: pointer; top: 4px; right: 9px;" /><iframe id="recordDescriptionFrame" src="'+
k+'" frameBorder="0" /></div>');$("#recordDescriptionOverlay > div").append('<div id="recordDescriptionLoading"><img src="'+this.imagesFolder+'/ajax-loading-bar.gif" /></div>');$("#recordDescriptionLoading").css({position:"absolute",top:g.top-($("#"+d).height()/2+10),left:g.left+($("#"+d).width()/2-110)});$("#recordDescriptionFrame").css({width:$("#"+d).css("width"),height:$("#"+d).height()-16+"px","padding-top":"16px","overflow-x":"hidden"});$("#recordDescriptionFrame").hide();$("#recordDescriptionFrame").load(function(){$("#recordDescriptionLoading").remove();
$("#recordDescriptionFrame").contents().find("head").append(b.recordDisplayCss);$("#recordDescriptionFrame").contents().find("a").attr("target","_new");var a=$("#recordDescriptionFrame").contents().find("title").text();$("#recordDescriptionFrame").contents().find("body").prepend("<h1>"+a+"</h1>");$("#recordDescriptionFrame").show()});$("#recordDescriptionOverlayClose").click(function(){b.closeRecordDescriptionOverlay()});$("#recordDescriptionOverlayOpen").click(function(){window.open(e,"_blank");
b.closeRecordDescriptionOverlay()});$("#recordDescriptionOverlay").fadeIn("fast",function(){})};this.closeRecordDescriptionOverlay=function(){$("#recordDescriptionOverlay").fadeOut("fast",function(){$("#recordDescriptionOverlay").empty()})};this.drawFocusPolygon=function(c,a){var a=this.hexc(a),d=new google.maps.MarkerImage(this.imagesFolder+"arrow_out.png",new google.maps.Size(16,16),new google.maps.Point(0,0),new google.maps.Point(8,8)),d=new google.maps.Marker({map:this.map,position:new google.maps.LatLng(c.map.getBounds().getNorthEast().lat(),
c.map.getBounds().getNorthEast().lng()),draggable:!0,title:"Move focus window",icon:d});d.focusMap=c;var g=new google.maps.Rectangle({map:this.map,fillColor:a,fillOpacity:"0.3",strokeWeight:1,strokeColor:a,bounds:c.map.getBounds()});c.map.bindTo("center",d,"position");g.bindTo("bounds",c.map,"position");g.setBounds(c.map.getBounds());g.focusMap=c;google.maps.event.addListener(d,"dragend",function(){b.searchOnDrag&&(b.selectedFocusMapID=this.focusMap.focusMapID,this.focusMap.toggleFocusWindowSelection(),
b.searchMap(this.focusMap.map))});return g};this.hexc=function(b){if(-1==b.indexOf("rgb("))return-1==b.indexOf("#")?"#"+b:b;b=b.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);delete b[0];for(var a=1;3>=a;++a)b[a]=parseInt(b[a]).toString(16),1==b[a].length&&(b[a]="0"+b[a]);return"#"+b.join("")};this.createWebMap(g);$(window).resize(function(){$("#webMap").width($("#webMap").parent().width());$(".webMapFiltersTd").width(0.35*$("#webMap").width());$(".webMapResultsTd").width(0.65*$("#webMap").width());b.enableFocusWindows&&
($("#mapFocus1").css("width","100%"),$("#mapFocus2").css("width","100%"),$("#mapFocus3").css("width","100%"),$("#mapFocus1").width($("#mapFocus1").width()),$("#mapFocus2").width($("#mapFocus2").width()),$("#mapFocus3").width($("#mapFocus3").width()))})}
function SWebMapFocus(){var g=this;this.focusPolygon=null;this.createFocusMap=function(d,b){this.sWebMap=d;this.color=$("#"+b).css("background-color");this.focusMapID=b.substring(b.length-1);var c={zoom:this.sWebMap.focusMapsCenterPositions["focusMap"+this.focusMapID].zoom,center:new google.maps.LatLng(this.sWebMap.focusMapsCenterPositions["focusMap"+this.focusMapID].lat,this.sWebMap.focusMapsCenterPositions["focusMap"+this.focusMapID].lng),disableDefaultUI:!0,mapTypeId:google.maps.MapTypeId.ROADMAP};
this.map=new google.maps.Map(document.getElementById(b),c);google.maps.event.addListenerOnce(this.map,"idle",function(){$("#mapFocus"+g.focusMapID).css("background-color","");google.maps.event.addListener(g.map,"bounds_changed",function(){null!=g.focusPolygon&&(g.focusPolygon.setBounds(g.map.getBounds()),g.focusMapID==g.sWebMap.selectedFocusMapID&&g.toggleFocusWindowSelection())});google.maps.event.addListener(g.map,"dragend",function(){g.sWebMap.searchOnDrag&&(g.sWebMap.selectedFocusMapID=g.focusMapID,
g.sWebMap.search())});google.maps.event.addListener(g.map,"zoom_changed",function(){g.sWebMap.searchOnZoomChanged&&(g.sWebMap.selectedFocusMapID=g.focusMapID,g.sWebMap.search())});google.maps.event.addListener(g.map,"click",function(){g.sWebMap.selectedFocusMapID=g.focusMapID;g.toggleFocusWindowSelection();null!=g.sWebMap.focusMapsResults[g.focusMapID]?g.sWebMap.prepareDisplayResults(g.sWebMap.focusMapsResults[g.focusMapID],g.map):g.sWebMap.search()});1==g.focusMapID&&(g.toggleFocusWindowSelection(),
g.sWebMap.selectedFocusMapID=g.focusMapID,g.sWebMap.search())})};this.toggleFocusWindowSelection=function(){$("#mapFocus"+g.focusMapID).removeClass("mapFocus"+g.focusMapID+"_unselected");$("#mapFocus"+g.focusMapID).addClass("mapFocus"+g.focusMapID+"_selected");1!=g.focusMapID&&($("#mapFocus1").removeClass("mapFocus1_selected"),$("#mapFocus1").addClass("mapFocus1_unselected"));2!=g.focusMapID&&($("#mapFocus2").removeClass("mapFocus2_selected"),$("#mapFocus2").addClass("mapFocus2_unselected"));3!=g.focusMapID&&
($("#mapFocus3").removeClass("mapFocus3_selected"),$("#mapFocus3").addClass("mapFocus3_unselected"))}};