$(document).ready(function(){Array.indexOf||(Array.prototype.indexOf=function(h){for(var d=0;d<this.length;d++)if(this[d]==h)return d;return-1})});
function SWebMap(h,d){var b=this;this.defaultMapLat=void 0!=d.defaultMapLat?d.defaultMapLat:"46.8415";this.defaultMapLong=void 0!=d.defaultMapLong?d.defaultMapLong:"-71.3198";this.defaultMapZoom=void 0!=d.defaultMapZoom?d.defaultMapZoom:10;this.defaultMarkerUrl=void 0!=d.defaultMarkerUrl?d.defaultMarkerUrl:"";this.displayAttributeFiltersCounts=void 0!=d.displayAttributeFiltersCounts?d.displayAttributeFiltersCounts:!1;this.displayResultsHTML=void 0!=d.displayResultsHTML?d.displayResultsHTML:!0;this.displayFilters=
void 0!=d.displayFilters?d.displayFilters:!0;this.displayTypeFiltersCounts=void 0!=d.displayTypeFiltersCounts?d.displayTypeFiltersCounts:!1;this.enableFocusWindows=void 0!=d.enableFocusWindows?d.enableFocusWindows:!1;this.enableRecordDisplayOverlay=void 0!=d.enableRecordDisplayOverlay?d.enableRecordDisplayOverlay:!0;this.enableRecordSelection=void 0!=d.enableRecordSelection?d.enableRecordSelection:!0;this.enableSessions=void 0!=d.enableSessions?d.enableSessions:!0;this.focusMapsCenterPositions=void 0!=
d.focusMapsCenterPositions?d.focusMapsCenterPositions:{focusMap1:{lat:"46.7659",lng:"-71.3198",zoom:12},focusMap2:{lat:"46.8056",lng:"-71.3153",zoom:12},focusMap3:{lat:"46.8303",lng:"-71.2216",zoom:12}};this.forceSearch=void 0!=d.forceSearch?d.forceSearch:!1;this.googleUrlShortenerKey=void 0!=d.googleUrlShortenerKey?d.googleUrlShortenerKey:"";this.imagesFolder=void 0!=d.imagesFolder?d.imagesFolder:"";this.includeResultsInTargetInclusionRecords=void 0!=d.includeResultsInTargetInclusionRecords?d.includeResultsInTargetInclusionRecords:
!1;this.initializationSession=void 0!=d.initializationSession?d.initializationSession:null;this.isAdmin=void 0!=d.isAdmin?d.isAdmin:!1;this.labels={};void 0==d.labels&&(d.labels={});this.labels.searchButton="undefined"!=typeof d.labels.searchButton?d.labels.searchButton:"Search";this.labels.searchInput="undefined"!=typeof d.labels.sesearchInputarchButton?d.labels.searchInput:"Search Map";this.labels.saveSessionButton="undefined"!=typeof d.labels.saveSessionButton?d.labels.saveSessionButton:"save";
this.labels.deleteSessionButton="undefined"!=typeof d.labels.deleteSessionButton?d.labels.deleteSessionButton:"delete";this.labels.shareSessionButton="undefined"!=typeof d.labels.shareSessionButton?d.labels.shareSessionButton:"share";this.labels.loadSavedMapSessionInput="undefined"!=typeof d.labels.loadSavedMapSessionInput?d.labels.loadSavedMapSessionInput:"Load saved map...";this.labels.sourcesFilterSectionHeader="undefined"!=typeof d.labels.sourcesFilterSectionHeader?d.labels.sourcesFilterSectionHeader:
"Sources";this.labels.typesFilterSectionHeader="undefined"!=typeof d.labels.typesFilterSectionHeader?d.labels.typesFilterSectionHeader:"Kinds";this.labels.attributesFilterSectionHeader="undefined"!=typeof d.labels.attributesFilterSectionHeader?d.labels.attributesFilterSectionHeader:"Attributes";this.labels.inclusionRecordsButtonOff="undefined"!=typeof d.labels.inclusionRecordsButtonOff?d.labels.inclusionRecordsButtonOff:"Show included records";this.labels.inclusionRecordsButtonOn="undefined"!=typeof d.labels.inclusionRecordsButtonOn?
d.labels.inclusionRecordsButtonOn:"Show all records";this.mapDatasets=void 0!=d.mapDatasets?d.mapDatasets:[];this.schemas=void 0!=d.schemas?d.schemas:[];this.mapResultsPerPage=void 0!=d.mapResultsPerPage?d.mapResultsPerPage:20;this.searchOnDrag=void 0!=d.searchOnDrag?d.searchOnDrag:!1;this.searchOnZoomChanged=void 0!=d.searchOnZoomChanged?d.searchOnZoomChanged:!1;this.sharedMapUrl=void 0!=d.sharedMapUrl?d.sharedMapUrl:"";this.structWSFAddress=void 0!=d.structWSFAddress?d.structWSFAddress:"http://localhost/ws/search/";
this.recordDisplayCss=void 0!=d.recordDisplayCss?d.recordDisplayCss:"";this.inclusionRecords=void 0!=d.inclusionRecords?d.inclusionRecords:[];this.session={name:"",notes:"",q:"",fd:[],fa:[],ft:[],av:{},attributes_boolean_operator:"and",records:[]};this.taggedRecords=[];this.currentResultsetPage=this.nbResults=0;this.datasetsTitles=[];this.markers=[];this.polygons=[];this.polylines=[];this.selectedMapId=-1;this.mapLoading=!1;this.templatesData=[];this.filtersDatasets=[];this.filtersTypes=[];this.filtersAttributes=
[];this.checkedFiltersDatasets=[];this.checkedFiltersTypes=[];this.checkedFiltersAttributes=[];this.attributeValueFilters={};this.results=[];this.taggedResults=[];this.letters="a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z".split(",");this.focusMaps=[];this.focusMapsResults={1:null,2:null,3:null};this.focusMapsTaggedRecords={1:[],2:[],3:[]};this.howManyFocusMapsCreated=0;this.selectedFocusMapID=-1;this.createWebMap=function(c){var a="",e=b.getUrlVars();if(e.map!=void 0&&e.map!=""&&typeof e.map!=
"function"&&JSON.parse(unescape(e.map)).fwe)this.enableFocusWindows=true;this.enableFocusWindows&&(a='<tr><td colspan="2" style="width: 100%"><table id="webMapFocusWindows"><tr><td style="padding: 0px; width: 33%;"><div id="mapFocus1" class="mapFocus1_unselected"></div></td><td style="padding: 0px; width: 34%;"><div id="mapFocus2" class="mapFocus2_unselected"></div></td><td style="padding: 0px; width: 33%;"><div id="mapFocus3" class="mapFocus3_unselected"></div></td></tr></table></td></tr>');$("#"+
c).append(' <div id="mapSessionsPanel" class="mapSessionsPanel" ></div><div id="mapSessionsMessagePanel" class="mapSessionsMessagePanel" ></div><div id="webMapSearch" class="webMapSearch" ></div><div id="webMapMain" class="webMapMain"></div><table id="webMap" class="webMap"><tbody style="border: none;">'+a+'<tr id="resultsCanvas"><td valign="top" class="webMapResultsTd"><div class="webMapResults" id="webMapResults"><div id="mapActionsButtons" class="mapActionsButtons"></div><div id="taggedRecordsBox" class="taggedRecordsBox"></div><div id="resultsBox" class="resultsBox"></div><div id="resultsPaginator" class="resultsPaginator"></div></div></td><td class="webMapFiltersTd" valign="top"><div id="webMapFilters" class="webMapFilters"></div></td></tr></tbody></table><div id="recordDescriptionOverlay" />');
$("#webMap").width($("#webMap").parent().width());$(".webMapFiltersTd").width($("#webMap").width()*0.35);$(".webMapResultsTd").width($("#webMap").width()*0.65);if(this.enableFocusWindows){$("#mapFocus1").width($("#mapFocus1").width());$("#mapFocus2").width($("#mapFocus2").width());$("#mapFocus3").width($("#mapFocus3").width())}$("#recordDescriptionOverlay").hide();c={zoom:this.defaultMapZoom,center:new google.maps.LatLng(this.defaultMapLat,this.defaultMapLong),mapTypeId:google.maps.MapTypeId.ROADMAP};
this.map=new google.maps.Map(document.getElementById("webMapMain"),c);google.maps.event.addListenerOnce(this.map,"idle",function(){google.maps.event.addListener(b.map,"dragend",function(){!b.mapLoading&&b.searchOnDrag&&!b.enableFocusWindows&&b.search()});google.maps.event.addListener(b.map,"zoom_changed",function(){!b.mapLoading&&b.searchOnZoomChanged&&!b.enableFocusWindows&&b.search()});if(b.enableFocusWindows){b.focusMaps.push(new SWebMapFocus);$("#mapFocus"+b.focusMaps.length).parent().css("height",
"300px");b.focusMaps[b.focusMaps.length-1].createFocusMap(b,"mapFocus"+b.focusMaps.length);b.focusMaps[b.focusMaps.length-1].focusPolygon=b.drawFocusPolygon(b.focusMaps[b.focusMaps.length-1],$("#mapFocus"+b.focusMaps.length).css("border-top-color"));google.maps.event.addListenerOnce(b.focusMaps[b.focusMaps.length-1].map,"idle",function(){b.howManyFocusMapsCreated++});b.focusMaps.push(new SWebMapFocus);$("#mapFocus"+b.focusMaps.length).parent().css("height","300px");b.focusMaps[b.focusMaps.length-
1].createFocusMap(b,"mapFocus"+b.focusMaps.length);b.focusMaps[b.focusMaps.length-1].focusPolygon=b.drawFocusPolygon(b.focusMaps[b.focusMaps.length-1],$("#mapFocus"+b.focusMaps.length).css("border-top-color"));google.maps.event.addListenerOnce(b.focusMaps[b.focusMaps.length-1].map,"idle",function(){b.howManyFocusMapsCreated++});b.focusMaps.push(new SWebMapFocus);$("#mapFocus"+b.focusMaps.length).parent().css("height","300px");b.focusMaps[b.focusMaps.length-1].createFocusMap(b,"mapFocus"+b.focusMaps.length);
b.focusMaps[b.focusMaps.length-1].focusPolygon=b.drawFocusPolygon(b.focusMaps[b.focusMaps.length-1],$("#mapFocus"+b.focusMaps.length).css("border-top-color"));google.maps.event.addListenerOnce(b.focusMaps[b.focusMaps.length-1].map,"idle",function(){b.howManyFocusMapsCreated++})}if(b.enableSessions){var a=document.createElement("DIV");new b.SaveButtonControl(a,b.map);a.index=1;b.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(a);a=document.createElement("DIV");a.id="deleteButtonDiv";new b.DeleteButtonControl(a,
b.map);a.index=1;b.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(a);$(a).hide();a=document.createElement("DIV");a.id="inclusionButtonDiv";new b.InclusionButtonControl(a,b.map);a.index=1;b.map.controls[google.maps.ControlPosition.BOTTOM_RIGHT].push(a);$(a).hide();if(b.googleUrlShortenerKey!=""&&b.sharedMapUrl!=""){a=document.createElement("DIV");a.id="linkButtonDiv";new b.LinkButtonControl(a,b.map);a.index=1;b.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(a);$(a).hide()}a=document.createElement("DIV");
a.id="selectMapDiv";new b.SelectMapControl(a,b.map);b.getSessions().length<=0&&$(a).hide();a.index=1;b.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(a)}$("#webMapMain").css("background-color","");b.displaySearch();if($.cookie("webmap-resultsperpage")!=null)b.mapResultsPerPage=$.cookie("webmap-resultsperpage");if(e.map!=void 0&&e.map!=""&&typeof e.map!="function"){b.startWaiting();b.mapLoading=true;a=JSON.parse(unescape(e.map));if(b.enableFocusWindows){var c=function(a){if(b.howManyFocusMapsCreated==
3){b.checkedFiltersDatasets=a.fd;b.checkedFiltersTypes=a.ft;b.checkedFiltersAttributes=a.fa;b.attributeValueFilters=a.av;if(a.notes!=""){$("#mapSessionsMessagePanel").empty();$("#mapSessionsMessagePanel").append('<table style="margin: 20px;"><tbody style="border: none;"><tr><td><h2 style="margin: 0px;">Notes:</h2><br />'+a.notes+"</td></tr></tbody></table>");$("#mapSessionsMessagePanel").fadeIn("slow",function(){})}var e=false;if(a.fwe){if(a.f1.r.length>0||a.f2.r.length>0||a.f3.r.length>0)e=true}else a.records.length>
0&&(e=true);e&&b.loadMap(a)}else setTimeout(c,250,a)};setTimeout(c,250,a)}else b.loadMap(a)}else if(typeof b.initializationSession!="undefined"&&b.initializationSession!=null){b.startWaiting();b.mapLoading=true;b.initializeMap();sessionInitialized=true;b.stopWaiting();b.mapLoading=false}else b.forceSearch&&b.search()})};this.search=function(){this.enableFocusWindows?this.searchMap(this.focusMaps[this.selectedFocusMapID-1].map):this.searchMap(this.map)};this.searchMap=function(c){if(this.session.q!=
""&&this.session.q!=this.labels.searchInput)this.session.q=$("#searchInput").val();var a="",e="",g="";if(this.session.fd.length>0){for(var f=0;f<this.session.fd.length;f++)a=a+this.session.fd[f]+";";a=a.substr(0,a.length-1)}else a=this.mapDatasets.join(";");if(this.session.ft.length>0){for(f=0;f<this.session.ft.length;f++)e=e+this.session.ft[f]+";";e=e.substr(0,e.length-1)}else e="all";var f=0,j;for(j in this.session.av)if(this.session.av.hasOwnProperty(j)){f++;break}if(f>0){for(j in this.session.av)this.session.av.hasOwnProperty(j)&&
(g=g+this.urlencode(j)+"::"+this.urlencode(this.session.av[j])+";");g=g.substr(0,g.length-1)}else g="all";if(this.includeResultsInTargetInclusionRecords){g=="all"&&(g="");for(j=0;j<this.inclusionRecords.length;j++)g=g+";"+this.urlencode("http://www.geonames.org/ontology#locatedIn")+"::"+this.urlencode(this.inclusionRecords[j])+";";this.session.attributes_boolean_operator=this.inclusionRecords.length>1?"or":"and"}f=c.getBounds();j=f.getNorthEast();f=f.getSouthWest();this.startWaiting();$.ajax({type:"POST",
url:this.structWSFAddress.replace(/\/+$/,"")+"/search/",data:"query="+($("#searchInput").val()==this.labels.searchInput?"":$("#searchInput").val())+"&datasets="+a+"&types="+e+"&attributes="+g+"&items="+this.mapResultsPerPage+"&page="+this.currentResultsetPage*this.mapResultsPerPage+"&inference="+(this.session.inference!=void 0&&this.session.inference=="on"?"on":"off")+"&attributes_boolean_operator="+this.session.attributes_boolean_operator+"&include_aggregates="+(this.displayFilters?"true":"false")+
"&range_filter="+j.lat()+";"+j.lng()+";"+f.lat()+";"+f.lng(),dataType:"json",targetMap:c,success:function(a){this.targetMap.b.id=="mapFocus1"&&(b.focusMapsResults["1"]=a);this.targetMap.b.id=="mapFocus2"&&(b.focusMapsResults["2"]=a);this.targetMap.b.id=="mapFocus3"&&(b.focusMapsResults["3"]=a);if(this.targetMap.b.id=="webMapMain")b.mainMapResults=a;b.prepareDisplayResults(a,this.targetMap)},error:function(){b.stopWaiting()}})};this.prepareDisplayResults=function(c,a){var e=new Resultset(c);b.nbResults=
0;var g=e.getSubjectsByType("http://purl.org/ontology/aggregate#Aggregate"),f=e.getSubjectsByPredicateObjectValue("http://purl.org/ontology/aggregate#property","http://rdfs.org/ns/void#Dataset",g);if($.cookie("webmap-datasetsTitles")!=null)b.datasetsTitles=JSON.parse(unescape($.cookie("webmap-datasetsTitles")));for(g=0;g<b.filtersDatasets.length;g++){b.filtersDatasets[g].selected=false;b.filtersDatasets[g].nbRecords=0}for(var j=0;j<f.length;j++){var g=f[j],d=g.predicate[1]["http://purl.org/ontology/aggregate#object"].uri,
k=g.predicate[2]["http://purl.org/ontology/aggregate#count"];b.datasetsTitles[d]||b.getDatasetsTitles();var l=false;b.checkedFiltersDatasets.indexOf(d)!=-1&&(l=true);for(var g=false,m=0;m<b.filtersDatasets.length;m++)if(b.filtersDatasets[m].uri==d){b.filtersDatasets[m].selected=l;b.filtersDatasets[m].nbRecords=k;g=true}g==false&&b.filtersDatasets.push({prefLabel:b.datasetsTitles[d],nbRecords:k,uri:d,selected:l})}g=e.getSubjectsByType("http://purl.org/ontology/aggregate#Aggregate");j=e.getSubjectsByPredicateObjectValue("http://purl.org/ontology/aggregate#property",
"http://www.w3.org/1999/02/22-rdf-syntax-ns#type",g);for(g=0;g<b.filtersTypes.length;g++){b.filtersTypes[g].selected=false;b.filtersTypes[g].nbRecords=0}for(f=0;f<j.length;f++){for(var g=j[f],h=g.predicate[1]["http://purl.org/ontology/aggregate#object"].uri,k=g.predicate[2]["http://purl.org/ontology/aggregate#count"],d=h,l=0;l<b.schemas.length;l++){var n=b.schemas[l].getType(h);if(n!=null){d=n.prefLabel;break}}n==null&&(h.lastIndexOf("#")!=-1?d=h.substring(h.lastIndexOf("#")+1).replace(/_/g," ").replace(/([A-Z])/g,
" $1").replace(/^\s+|\s+$/g,""):h.lastIndexOf("/")!=-1&&(d=h.substring(h.lastIndexOf("/")+1).replace(/_/g," ").replace(/([A-Z])/g," $1").replace(/^\s+|\s+$/g,"")));l=false;b.checkedFiltersTypes.indexOf(h)!=-1&&(l=true);g=false;for(m=0;m<b.filtersTypes.length;m++)if(b.filtersTypes[m].uri==h){b.filtersTypes[m].selected=l;b.filtersTypes[m].nbRecords=k;g=true}g==false&&b.filtersTypes.push({prefLabel:d,nbRecords:k,uri:h,selected:l})}g=e.getSubjectsByType("http://purl.org/ontology/aggregate#Aggregate");
n=e.getSubjectsByPredicateObjectValue("http://purl.org/ontology/aggregate#property","http://www.w3.org/1999/02/22-rdf-syntax-ns#Property",g);for(g=0;g<b.filtersAttributes.length;g++){b.filtersAttributes[g].selected=false;b.filtersAttributes[g].nbRecords=0}for(f=0;f<n.length;f++){g=n[f];j=g.predicate[1]["http://purl.org/ontology/aggregate#object"].uri;k=g.predicate[2]["http://purl.org/ontology/aggregate#count"];d=j;for(l=0;l<b.schemas.length;l++){var o=b.schemas[l].getAttribute(j);if(o!=null){d=o.prefLabel;
break}}o==null&&(j.lastIndexOf("#")!=-1?d=j.substring(j.lastIndexOf("#")+1).replace(/_/g," ").replace(/([A-Z])/g," $1").replace(/^\s+|\s+$/g,""):j.lastIndexOf("/")!=-1&&(d=j.substring(j.lastIndexOf("/")+1).replace(/_/g," ").replace(/([A-Z])/g," $1").replace(/^\s+|\s+$/g,"")));l=false;b.checkedFiltersAttributes.indexOf(j)!=-1&&(l=true);g=false;for(m=0;m<b.filtersAttributes.length;m++)if(b.filtersAttributes[m].uri==j){b.filtersAttributes[m].selected=l;b.filtersAttributes[m].nbRecords=k;g=true}g==false&&
b.filtersAttributes.push({prefLabel:d,nbRecords:k,uri:j,selected:l})}b.results=[];for(l=0;l<e.subjects.length;l++){o=e.subjects[l];if(o.type=="http://purl.org/ontology/aggregate#Aggregate"&&o.getPredicateValues("http://purl.org/ontology/aggregate#property")[0].uri=="http://rdfs.org/ns/void#Dataset")b.nbResults=b.nbResults+parseInt(o.getPredicateValues("http://purl.org/ontology/aggregate#count")[0]);if(o.type!="http://purl.org/ontology/aggregate#Aggregate"){g=b.getResultDefinition(o);b.results.push(g)}}if(this.displayResultsHTML){b.displayResultsPagination(b.nbResults,
b.currentResultsetPage);b.displayResults();b.displayTaggedRecords(this.taggedResults);if(this.displayFilters){b.displayFiltersDataset();b.displayFiltersType();b.displayFiltersAttribute()}else $(".webMapFiltersTd").hide()}b.hideUntaggedRecords();for(l=0;l<e.subjects.length;l++){o=e.subjects[l];if(o.type!="http://purl.org/ontology/aggregate#Aggregate"){g=false;for(n=0;n<b.markers.length;n++){k=b.markers[n];if(k.data.uri==o.uri){g=true;k.setVisible(true);break}}if(!g){k=o.getPredicateValues("http://www.w3.org/2003/01/geo/wgs84_pos#lat");
m=o.getPredicateValues("http://www.w3.org/2003/01/geo/wgs84_pos#long");if(k.length==1&&m.length==1){f="";for(j=0;j<b.schemas.length;j++){n=b.schemas[j].getType(o.type);if(n!=null&&n.mapMarkerImageUrl!=void 0&&n.mapMarkerImageUrl!=null){f=n.mapMarkerImageUrl[0];break}}if(f==""&&this.defaultMarkerUrl!="")f=this.defaultMarkerUrl;n=f!=""?{icon:f,position:new google.maps.LatLng(k[0],m[0]),map:a,title:b.stripHtml(o.getPrefLabel())}:{position:new google.maps.LatLng(k[0],m[0]),map:a,title:b.stripHtml(o.getPrefLabel())};
k=new google.maps.Marker(n);k.data=o;google.maps.event.addListener(k,"mouseover",function(){b.featureOver(this.data.uri)});b.markers.push(k)}}if(!g){for(var r=0;r<b.polygons.length;r++){var q=b.polygons[r];if(q.data.uri==o.uri){g=true;q.setMap(a)}}if(!g)for(var k=o.getPredicateValues("http://purl.org/ontology/sco#polygonCoordinates"),s=null,n=0;n<k.length;n++){m=k[n].split(" ");q=[];d=new google.maps.LatLngBounds;for(f=0;f<m.length;f++){j=m[f];j=j.split(",");q.push(new google.maps.LatLng(j[1],j[0]));
d=d.extend(new google.maps.LatLng(j[1],j[0]));s==null&&(s=new google.maps.LatLng(j[1],j[0]))}q=new google.maps.Polygon({paths:q,strokeColor:"#CA2251",strokeOpacity:0.7,strokeWeight:2,fillColor:"#CA2251",fillOpacity:0.05});q.data=o;q.bounds=d;m=document.createElement("div");m.style.cssText="font-weight: bolder; border: 1px solid #3366CC; margin-top: 8px; background: #3366CC; padding: 3px; color: black;";m.innerHTML=o.getPrefLabel();m={content:m,disableAutoPan:true,maxWidth:0,pixelOffset:new google.maps.Size(0,
10),zIndex:null,boxStyle:{background:"",opacity:0.9},closeBoxMargin:"10px 2px 2px 2px",closeBoxURL:"",infoBoxClearance:new google.maps.Size(1,1),isHidden:true,pane:"floatPane",enableEventPropagation:false};m=new InfoBox(m);m.open(a);q.infobox=m;google.maps.event.addListener(q,"mouseout",function(){this.infobox.hide()});google.maps.event.addListener(q,"mouseover",function(){this.infobox.show();b.featureOver(this.data.uri)});google.maps.event.addListener(q,"mousemove",function(a){this.infobox.setPosition(a.latLng)});
b.polygons.push(q);q.setMap(a)}}if(!g){for(n=0;n<b.polylines.length;n++){k=b.polylines[n];if(k.data.uri==o.uri){g=true;k.setMap(a)}}if(!g){g=o.getPredicateValues("http://purl.org/ontology/sco#polylineCoordinates");for(n=0;n<g.length;n++){m=g[n].split(" ");k=[];d=new google.maps.LatLngBounds;for(f=0;f<m.length;f++){j=m[r];j=j.split(",");k.push(new google.maps.LatLng(j[1],j[0]));d=d.extend(new google.maps.LatLng(j[1],j[0]));s==null&&(s=new google.maps.LatLng(j[1],j[0]))}k=new google.maps.Polyline({path:k,
strokeColor:"#CA2251",strokeOpacity:0.7,strokeWeight:2,fillColor:"#CA2251",fillOpacity:0.05});k.data=o;k.bounds=d;m=document.createElement("div");m.style.cssText="font-weight: bolder; border: 1px solid #3366CC; margin-top: 8px; background: #3366CC; padding: 3px; color: black;";m.innerHTML=o.getPrefLabel();m={content:m,disableAutoPan:true,maxWidth:0,pixelOffset:new google.maps.Size(0,10),zIndex:null,boxStyle:{background:"",opacity:0.9},closeBoxMargin:"10px 2px 2px 2px",closeBoxURL:"",infoBoxClearance:new google.maps.Size(1,
1),isHidden:true,pane:"floatPane",enableEventPropagation:false};m=new InfoBox(m);m.open(a);k.infobox=m;google.maps.event.addListener(k,"mouseout",function(){b.infobox.hide()});google.maps.event.addListener(k,"mouseover",function(){b.infobox.show();b.featureOver(this.data.uri)});google.maps.event.addListener(q,"mousemove",function(a){this.infobox.setPosition(a.latLng)});b.polylines.push(k);k.setMap(a)}}}}}b.stopWaiting()};this.stripHtml=function(c){var a=document.createElement("DIV");a.innerHTML=c;
return a.textContent||a.innerText};this.displayTaggedRecords=function(c){this.taggedResults=c;$(".result-tag").remove();$("#taggedRecordsBox").show();if(c.length>0){$("#taggedRecordsBox").append('<div id="showSelectedRecordsOnlyDiv" class="result-tag"><span>Show selected records only <input type="checkbox" name="showSelectedRecordsOnlyCheckbox" id="showSelectedRecordsOnlyCheckbox" title=""></span></div>');$("#showSelectedRecordsOnlyCheckbox").click(function(){this.checked!=void 0&&(this.checked?b.clearMap():
b.search())})}else $("#showSelectedRecordsOnlyDiv").remove();for(var a=0;a<c.length;a++){for(var e=c[a].resultset,g={},f=0;f<e.predicate.length;f++)for(var j in e.predicate[f])e.predicate[f][j].uri!=void 0?g[j.replace(":","_").replace(/[^A-Za-z0-9_-]/g,"-")]=e.predicate[f][j].uri:g[j.replace(":","_").replace(/[^A-Za-z0-9_-]/g,"-")]=e.predicate[f][j];this.templatesData.push(g);this.taggedRecords.indexOf(c[a].uri)==-1&&this.taggedRecords.push(c[a].uri);$("#taggedRecordsBox").append('<div id="tagged_result_'+
a+'" class="result-tag"></div>');$("#tagged_result_"+a).mouseover(function(){var a=this.id.substring(this.id.lastIndexOf("_")+1);b.recordOver(b.taggedRecords[a])}).mouseout(function(){var a=this.id.substring(this.id.lastIndexOf("_")+1);b.recordOut(b.taggedRecords[a])});$("#tagged_result_"+a).append('<table class="taggedResultTable"><tr><td id="tagged_result_column_left_'+a+'" class="resultLeftColumn"></td><td id="tagged_result_column_image_'+a+'" class="resultImageColumn"></td><td id="tagged_result_column_center_'+
a+'"  class="resultCenterColumn"></td><td id="tagged_result_column_right_'+a+'" class="resultRightColumn"></td></tr></div>');$("#tagged_result_column_left_"+a).append(this.letters[a]+". ");if(c[a].markerImageUrl!=""){$("#tagged_result_column_image_"+a).attr("title",c[a].typePrefLabel);$("#tagged_result_column_image_"+a).append('<img src="'+c[a].markerImageUrl+'" />')}else if(c[a].polygonColor!=""){$("#tagged_result_column_image_"+a).attr("title",c[a].typePrefLabel);$("#tagged_result_column_image_"+
a).append('<div id="tagged_result_column_canvas_'+a+'" style="top:-3px;left:20px;position:relative;width:60px;height:30px;"></div>');e=new jsGraphics(document.getElementById("tagged_result_column_canvas_"+a));f=new jsColor(c[a].polygonColor.replace("0x","#"));e.fillPolygon(f,[new jsPoint(3,5),new jsPoint(11,6),new jsPoint(17,9),new jsPoint(15,17),new jsPoint(12,21),new jsPoint(17,22),new jsPoint(21,27),new jsPoint(15,31),new jsPoint(6,28),new jsPoint(1,25),new jsPoint(-1,14)])}else if(c[a].polylineColor!=
""){$("#tagged_result_column_image_"+a).attr("title",c[a].typePrefLabel);$("#tagged_result_column_image_"+a).append('<div id="tagged_result_column_canvas_'+a+'" style="top:-3px;left:20px;position:relative;width:60px;height:30px;"></div>');e=new jsGraphics(document.getElementById("tagged_result_column_canvas_"+a));f=new jsColor(c[a].polylineColor.replace("0x","#"));f=new jsPen(f,2);e.drawPolyline(f,[new jsPoint(2,2),new jsPoint(13,8),new jsPoint(5,17),new jsPoint(19,18)])}else{$("#tagged_result_column_image_"+
a).attr("title",c[a].typePrefLabel);$("#tagged_result_column_image_"+a).append('<img src="'+this.defaultMarkerUrl+'" />')}if(this.isAdmin){var e="",d;for(d in this.templatesData[a])e=e+(d+" = "+this.templatesData[a][d].replace(/"/,"").replace(/'/,"")+"\\n");$("#tagged_result_column_right_"+a).append('<img title="See record data (used for templating purposes)" src="'+this.imagesFolder+'application_form_edit.png" onclick="alert(\''+e+'\');" style="cursor:pointer; padding-right: 3px;" />')}if(this.enableRecordSelection){$("#tagged_result_column_right_"+
a).append('<input type="checkbox" name="tagged_result_checkbox_'+a+'" title="Persist this result" checked>');$("#tagged_result_column_right_"+a+" > input").click(function(){var a=this.parentNode.id.substring(this.parentNode.id.lastIndexOf("_")+1);b.tagRecord(this,c[a].uri)})}if(templates[c[a].type]!=void 0){$("#tagged_result_column_center_"+a).append(templates[c[a].type]);typeof templatesDirectives!="undefined"&&templatesDirectives[c[a].type]!=void 0?$("#tagged_result_column_center_"+a+" > div").autoRender(g,
templatesDirectives[c[a].type]):$("#tagged_result_column_center_"+a+" > div").autoRender(g);$("#tagged_result_column_center_"+a+" > div a[href='']").remove();$("#tagged_result_column_center_"+a+" > div img[src='']").remove();$("#tagged_result_column_center_"+a).find(".resultTitle").data("id",a);$("#tagged_result_column_center_"+a).find(".resultTitle").click(function(){b.enableRecordDisplayOverlay?b.openRecordDescriptionOverlay($(this).data("id"),true):window.open(b.taggedResults[$(this).data("id")].uri,
"_blank")})}else{$("#tagged_result_column_center_"+a).append('<div class="resultTitle"><a>'+c[a].prefLabel+"</a></div>");$("#tagged_result_column_center_"+a).append('<div class="resultDescription">'+c[a].description+"</div>");$("#tagged_result_column_center_"+a+" > div > a").click(function(){var a=this.parentNode.parentNode.id.substring(this.parentNode.parentNode.id.lastIndexOf("_")+1);b.enableRecordDisplayOverlay?b.openRecordDescriptionOverlay(a,true):window.open(b.taggedResults[a].uri,"_blank")})}$("#tagged_result_"+
a).mouseover(function(){this.id.substring(this.id.lastIndexOf("_")+1)}).mouseout(function(){this.id.substring(this.id.lastIndexOf("_")+1)})}};this.featureOver=function(c){for(var a=0;a<this.taggedRecords.length;a++)if(this.taggedRecords[a]==c){$("#webMapResults").scrollTo("#tagged_result_"+a);this.highlightTaggedResult(a);return}for(a=0;a<this.results.length;a++)if(this.results[a].uri==c){$("#webMapResults").scrollTo("#result_"+a);this.highlightResult(a);break}};this.recordOver=function(c){for(var a=
0;a<this.markers.length;a++){var b=this.markers[a];if(b.data.uri==c){b.setAnimation(google.maps.Animation.BOUNCE);return}}for(a=0;a<this.polygons.length;a++){b=this.polygons[a];if(b.data.uri==c){b.setOptions({strokeColor:"#99CCFF",fillColor:"#99CCFF"});return}}for(a=0;a<this.polylines.length;a++){b=this.polylines[a];if(b.data.uri==c){b.setOptions({strokeColor:"#99CCFF",fillColor:"#99CCFF"});break}}};this.recordOut=function(c){for(var a=0;a<this.markers.length;a++){var b=this.markers[a];if(b.data.uri==
c){b.setAnimation(null);return}}for(a=0;a<this.polygons.length;a++){b=this.polygons[a];if(b.data.uri==c){b.setOptions({strokeColor:"#CA2251",fillColor:"#CA2251"});return}}for(a=0;a<this.polylines.length;a++){b=this.polylines[a];if(b.data.uri==c){b.setOptions({strokeColor:"#CA2251",fillColor:"#CA2251"});break}}};this.displayResults=function(){$(".result-odd").remove();$(".result-even").remove();$(".result-highlight").remove();$(".noSearchResults").remove();var c=0;if(this.results.length==0)this.taggedRecords.length<=
0&&!this.mapLoading&&$("#resultsBox").append('<div class="noSearchResults">No results for the <b>"'+($("#searchInput").val()==this.labels.searchInput?"":$("#searchInput").val())+'"</b> search keywords and for this this.map region and selected filters. <br /><br />You can try zooming-out the this.map to get this.results elsewhere in the city.</div>');else{this.templatesData=[];for(var a=0;a<this.results.length;a++)if(!(this.taggedRecords.indexOf(this.results[a].uri)>=0)){for(var e=this.results[a].resultset,
g={},f=0;f<e.predicate.length;f++)for(var j in e.predicate[f])e.predicate[f][j].uri!=void 0?g[j.replace(":","_").replace(/[^A-Za-z0-9_-]/g,"-")]=e.predicate[f][j].uri:typeof e.predicate[f][j]=="object"&&"value"in e.predicate[f][j]?g[j.replace(":","_").replace(/[^A-Za-z0-9_-]/g,"-")]=e.predicate[f][j].value:g[j.replace(":","_").replace(/[^A-Za-z0-9_-]/g,"-")]=e.predicate[f][j];this.templatesData.push(g);e=false;for(f=0;f<this.taggedRecords.length;f++)if(this.taggedRecords[f].uri==this.results[a].uri){e=
true;break}if(!e){c++;a%2==0?$("#resultsBox").append('<div id="result_'+a+'" class="result-even"></div>'):$("#resultsBox").append('<div id="result_'+a+'" class="result-odd"></div>');$("#result_"+a).append('<table class="resultTable"><tr><td id="result_column_left_'+a+'" class="resultLeftColumn"></td><td id="result_column_image_'+a+'" class="resultImageColumn"></td><td id="result_column_center_'+a+'"  class="resultCenterColumn"></td><td id="result_column_right_'+a+'" class="resultRightColumn"></td></tr></div>');
if($.cookie("webmap-resultsperpage")!=null)this.mapResultsPerPage=$.cookie("webmap-resultsperpage");$("#result_column_left_"+a).append(c+this.currentResultsetPage*this.mapResultsPerPage+". ");if(this.results[a].markerImageUrl!=""){$("#result_column_image_"+a).attr("title",this.results[a].typePrefLabel);$("#result_column_image_"+a).append('<img src="'+this.results[a].markerImageUrl+'" />')}else if(this.results[a].polygonColor!=""){$("#result_column_image_"+a).attr("title",this.results[a].typePrefLabel);
$("#result_column_image_"+a).append('<div id="result_column_canvas_'+a+'" style="top:-3px;left:20px;position:relative;width:60px;height:30px;"></div>');e=new jsGraphics(document.getElementById("result_column_canvas_"+a));f=new jsColor(this.results[a].polygonColor.replace("0x","#"));e.fillPolygon(f,[new jsPoint(3,5),new jsPoint(11,6),new jsPoint(17,9),new jsPoint(15,17),new jsPoint(12,21),new jsPoint(17,22),new jsPoint(21,27),new jsPoint(15,31),new jsPoint(6,28),new jsPoint(1,25),new jsPoint(-1,14)])}else if(this.results[a].polylineColor!=
""){$("#result_column_image_"+a).attr("title",this.results[a].typePrefLabel);$("#result_column_image_"+a).append('<div id="result_column_canvas_'+a+'" style="top:-3px;left:20px;position:relative;width:60px;height:30px;"></div>');e=new jsGraphics(document.getElementById("result_column_canvas_"+a));f=new jsColor(this.results[a].polylineColor.replace("0x","#"));f=new jsPen(f,2);e.drawPolyline(f,[new jsPoint(2,2),new jsPoint(13,8),new jsPoint(5,17),new jsPoint(19,18)])}else{$("#result_column_image_"+
a).attr("title",this.results[a].typePrefLabel);$("#result_column_image_"+a).append('<img src="'+this.defaultMarkerUrl+'" />')}if(this.isAdmin){var e="",d;for(d in this.templatesData[a])e=e+(d+" = "+this.templatesData[a][d].replace(/"/,"").replace(/'/,"")+"\\n");$("#result_column_right_"+a).append('<img title="See record data (used for templating purposes)" src="'+this.imagesFolder+'application_form_edit.png" onclick="alert(\''+e+'\');" style="cursor:pointer; padding-right: 3px;" />')}if(this.enableRecordSelection){$("#result_column_right_"+
a).append('<input type="checkbox" name="result_checkbox_'+a+'" id="result_checkbox_'+a+'" title="Persist this result">');$("#result_column_right_"+a+" > input").click(function(){var a=this.parentNode.id.substring(this.parentNode.id.lastIndexOf("_")+1);b.tagRecord(this,b.results[a].uri)});this.displayHelpTipsHover("result_checkbox_"+a,"Persist result on map","s")}if(templates[this.results[a].type]!=void 0){$("#result_column_center_"+a).append(templates[this.results[a].type]);typeof templatesDirectives!=
"undefined"&&templatesDirectives[this.results[a].type]!=void 0?$("#result_column_center_"+a+" > div").autoRender(g,templatesDirectives[this.results[a].type]):$("#result_column_center_"+a+" > div").autoRender(g);$("#result_column_center_"+a+" > div a[href='']").remove();$("#result_column_center_"+a+" > div img[src='']").remove();$("#result_column_center_"+a).find(".resultTitle").data("id",a);$("#result_column_center_"+a).find(".resultTitle").click(function(){b.enableRecordDisplayOverlay?b.openRecordDescriptionOverlay($(this).data("id"),
false):window.open(b.taggedResults[$(this).data("id")].uri,"_blank")})}else{$("#result_column_center_"+a).append('<div class="resultTitle"><a>'+this.results[a].prefLabel+"</a></div>");$("#result_column_center_"+a).append('<div class="resultDescription">'+this.results[a].description+"</div>");$("#result_column_center_"+a+" > div > a").click(function(){var a=this.parentNode.parentNode.id.substring(this.parentNode.parentNode.id.lastIndexOf("_")+1);b.enableRecordDisplayOverlay?b.openRecordDescriptionOverlay(a,
false):window.open(b.taggedResults[a].uri,"_blank")})}$("#result_"+a).mouseover(function(){var a=this.id.substring(this.id.lastIndexOf("_")+1);b.recordOver(b.results[a].uri)}).mouseout(function(){var a=this.id.substring(this.id.lastIndexOf("_")+1);b.recordOut(b.results[a].uri)})}}$("#webMapResults").scrollTo(0);$("#webMapFilters").scrollTo(0)}};this.tagRecord=function(c,a){$(".tipsy").remove();this.recordOut(a);var e="added";if(c.checked!=void 0)if(c.checked){var g=c.name.substring(c.name.lastIndexOf("_")+
1);$("#result_"+g).remove();this.renumberResults();this.taggedRecords.indexOf(a)==-1&&this.taggedRecords.push(a)}else{if(this.taggedRecords.indexOf(a)!=-1){this.taggedRecords.splice(this.taggedRecords.indexOf(a),1);for(e=0;e<this.taggedResults.length;e++)if(this.taggedResults[e].uri==a){this.taggedResults.splice(e,1);break}e="removed"}}else this.taggedRecords.push(a);this.enableFocusWindows&&(e=="added"?this.focusMapsTaggedRecords[this.selectedFocusMapID].push(a):this.focusMapsTaggedRecords[this.selectedFocusMapID].splice(this.focusMapsTaggedRecords[this.selectedFocusMapID].indexOf(a),
1));if(e=="added"){g=false;for(e=0;e<this.results.length;e++)if(this.results[e].uri==a){g=true;break}if(g)this.taggedResults.push(this.results[e]);else{unparsedResultset=$.ajax({type:"GET",url:this.structWSFAddress.replace(/\/+$/,"")+"/crud/read/?uri="+this.urlencode(a),dataType:"json",async:false}).responseText;e=(new Resultset(JSON.parse(unparsedResultset))).getSubject(a);htmlSubject=this.getResultDefinition(e);this.taggedResults.push(htmlSubject);for(var g=false,f=0;f<this.markers.length;f++){var d=
this.markers[f];if(d.data.uri==e.uri){g=true;d.setVisible(true);if(!this.enableFocusWindows)break}}if(!g){f=e.getPredicateValues("http://www.w3.org/2003/01/geo/wgs84_pos#lat");d=e.getPredicateValues("http://www.w3.org/2003/01/geo/wgs84_pos#long");if(f.length==1&&d.length==1){for(var h="",k=0;k<this.schemas.length;k++){var l=this.schemas[k].getType(e.type);if(l!=null&&l.mapMarkerImageUrl!=void 0&&l.mapMarkerImageUrl!=null){h=l.mapMarkerImageUrl[0];break}}if(h==""&&this.defaultMarkerUrl!="")h=this.defaultMarkerUrl;
f=h!=""?{icon:h,position:new google.maps.LatLng(f[0],d[0]),map:this.selectedFocusMapID==-1?this.map:this.focusMaps[this.selectedFocusMapID-1].map,title:this.stripHtml(e.getPrefLabel())}:{position:new google.maps.LatLng(f[0],d[0]),map:this.selectedFocusMapID==-1?this.map:this.focusMaps[this.selectedFocusMapID-1].map,title:this.stripHtml(e.getPrefLabel())};d=new google.maps.Marker(f);d.data=e;google.maps.event.addListener(d,"mouseover",function(){b.featureOver(this.data.uri)});this.markers.push(d)}}if(!g){for(var m=
0;m<this.polygons.length;m++){var p=this.polygons[m];if(p.data.uri==e.uri){g=true;p.setMap(this.selectedFocusMapID==-1?this.map:this.focusMaps[this.selectedFocusMapID].map)}}if(!g)for(var d=e.getPredicateValues("http://purl.org/ontology/sco#polygonCoordinates"),n=null,f=0;f<d.length;f++){for(var h=d[f].split(" "),p=[],o=new google.maps.LatLngBounds,k=0;k<h.length;k++){l=h[k];l=l.split(",");p.push(new google.maps.LatLng(l[1],l[0]));o=o.extend(new google.maps.LatLng(l[1],l[0]));n==null&&(n=new google.maps.LatLng(l[1],
l[0]))}p=new google.maps.Polygon({paths:p,strokeColor:"#CA2251",strokeOpacity:0.7,strokeWeight:2,fillColor:"#CA2251",fillOpacity:0.05});p.data=e;p.bounds=o;h=document.createElement("div");h.style.cssText="font-weight: bolder; border: 1px solid #3366CC; margin-top: 8px; background: #3366CC; padding: 3px; color: black;";h.innerHTML=e.getPrefLabel();h={content:h,disableAutoPan:true,maxWidth:0,pixelOffset:new google.maps.Size(0,10),zIndex:null,boxStyle:{background:"",opacity:0.9},closeBoxMargin:"10px 2px 2px 2px",
closeBoxURL:"",infoBoxClearance:new google.maps.Size(1,1),isHidden:true,pane:"floatPane",enableEventPropagation:false};h=new InfoBox(h);h.open(this.selectedFocusMapID==-1?this.map:this.focusMaps[this.selectedFocusMapID].map);p.infobox=h;google.maps.event.addListener(p,"mouseout",function(){this.infobox.hide()});google.maps.event.addListener(p,"mouseover",function(){this.infobox.show();b.featureOver(this.data.uri)});google.maps.event.addListener(p,"mousemove",function(a){this.infobox.setPosition(a.latLng)});
this.polygons.push(p);p.setMap(this.selectedFocusMapID==-1?this.map:this.focusMaps[this.selectedFocusMapID].map)}}if(!g){for(f=0;f<this.polylines.length;f++){d=this.polylines[f];if(d.data.uri==e.uri){g=true;d.setMap(this.selectedFocusMapID==-1?this.map:this.focusMaps[this.selectedFocusMapID].map)}}if(!g){g=e.getPredicateValues("http://purl.org/ontology/sco#polylineCoordinates");for(f=0;f<g.length;f++){h=g[f].split(" ");d=[];o=new google.maps.LatLngBounds;for(k=0;k<h.length;k++){l=h[m];l=l.split(",");
d.push(new google.maps.LatLng(l[1],l[0]));o=o.extend(new google.maps.LatLng(l[1],l[0]));n==null&&(n=new google.maps.LatLng(l[1],l[0]))}d=new google.maps.Polyline({path:d,strokeColor:"#CA2251",strokeOpacity:0.7,strokeWeight:2,fillColor:"#CA2251",fillOpacity:0.05});d.data=e;d.bounds=o;h=document.createElement("div");h.style.cssText="font-weight: bolder; border: 1px solid #3366CC; margin-top: 8px; background: #3366CC; padding: 3px; color: black;";h.innerHTML=e.getPrefLabel();h={content:h,disableAutoPan:true,
maxWidth:0,pixelOffset:new google.maps.Size(0,10),zIndex:null,boxStyle:{background:"",opacity:0.9},closeBoxMargin:"10px 2px 2px 2px",closeBoxURL:"",infoBoxClearance:new google.maps.Size(1,1),isHidden:true,pane:"floatPane",enableEventPropagation:false};h=new InfoBox(h);h.open(this.selectedFocusMapID==-1?this.map:this.focusMaps[this.selectedFocusMapID].map);d.infobox=h;google.maps.event.addListener(d,"mouseout",function(){this.infobox.hide()});google.maps.event.addListener(d,"mouseover",function(){this.infobox.show();
b.featureOver(this.data.uri)});google.maps.event.addListener(p,"mousemove",function(a){this.infobox.setPosition(a.latLng)});this.polylines.push(d);d.setMap(this.selectedFocusMapID==-1?this.map:this.focusMaps[this.selectedFocusMapID].map)}}}}}this.renumberResults();this.displayResults();this.displayTaggedRecords(this.taggedResults)};this.renumberResults=function(){for(var c=1,a=0;a<128;a++)if($("#result_column_left_"+a).length>0){$("#result_column_left_"+a).text(c+". ");c++}};this.highlightTaggedResult=
function(c){$("#webMapResults").find("*").removeClass("result-highlight");for(var a=0;a<this.taggedRecords.length;a++)if(a==c){$("#tagged_result_"+a).addClass("result-highlight");break}};this.highlightResult=function(c){$("#webMapResults").find("*").removeClass("result-highlight");for(var a=0;a<this.results.length;a++)a==c?$("#result_"+a).addClass("result-highlight"):a%2==0?$("#result_"+a).addClass("result-even"):$("#result_"+a).addClass("result-odd")};this.displayResultsPagination=function(c,a){if(c<=
this.mapResultsPerPage)$("#resultsPaginator").hide();else{$("#resultsPaginator").show();this.currentResultsetPage=a}$("#resultsPaginator").pagination(c,{items_per_page:this.mapResultsPerPage,num_display_entries:7,num_edge_entries:1,current_page:a,callback:this.handlePaginationClick});$.cookie("webmap-resultsperpage")==null?$.cookie("webmap-resultsperpage",20,{expires:365,path:"/"}):this.mapResultsPerPage=$.cookie("webmap-resultsperpage");var e='<select style="float:right; margin-right: 10px;">',e=
this.mapResultsPerPage==20?e+'<option value="20" selected>20</option>':e+'<option value="20">20</option>',e=this.mapResultsPerPage==50?e+'<option value="50" selected>50</option>':e+'<option value="50">50</option>',e=this.mapResultsPerPage==100?e+'<option value="100" selected>100</option>':e+'<option value="100">100</option>',e=this.mapResultsPerPage==200?e+'<option value="200" selected>200</option>':e+'<option value="200">200</option>';$("#resultsPaginator").append(e+"</select>");$("#resultsPaginator > select").change(function(){b.changeResultsPerPage(this)})};
this.changeResultsPerPage=function(c){this.mapResultsPerPage=c.value;$.cookie("webmap-resultsperpage",c.value,{expires:365,path:"/"});this.search()};this.handlePaginationClick=function(c){if(this.current_page!=c){b.currentResultsetPage=c;b.search()}return false};this.displayFiltersDataset=function(){$(".webMapFiltersTitleDataset").remove();$(".webMapFiltersDataset").remove();var c="";if($("#searchDatasetFilterForm").length>0){c=$("#quicksearchinput_filterdatasets").val();$("#searchDatasetFilterForm").remove()}if(this.filtersDatasets.length>
0){$("#webMapFilters").append('<div id="webMapFiltersTitleDataset" class="webMapFiltersTitleDataset">'+this.labels.sourcesFilterSectionHeader+"</div>");this.displayHelpTipsHover("webMapFiltersTitleDataset","Filter results by their provenance","e");$("#webMapFilters").append('<form method="get" id="searchDatasetFilterForm"><div style="padding-bottom: 5px;"><img src="'+this.imagesFolder+'magnifier.png" style="position: relative; top: 4px; left: 3px"> <input type="text" value="" name="q" id="quicksearchinput_filterdatasets" style="margin-left: 4px" autocomplete="off" /></div></form>');
this.displayHelpTipsHover("searchDatasetFilterForm","Filter displayed sources","e");$("#webMapFilters").append('<div id="webMapFiltersDataset" class="webMapFiltersDataset"></div>');for(var a=0;a<this.filtersDatasets.length;a++){$("#webMapFiltersDataset").append('<div id="filter_dataset_'+a+'" class="webMapFiltersDatasetItem"></div>');this.displayHelpTipsHover("filter_dataset_"+a,'Only shows result in "'+this.filtersDatasets[a].prefLabel+'"',"e");this.checkedFiltersDatasets.indexOf(this.filtersDatasets[a].uri)!=
-1?$("#filter_dataset_"+a).append('<label><input class="datasetCheckbox" type="checkbox" name="filter_dataset_checkbox_'+a+'" id="filter_dataset_checkbox_'+a+'" title="Only display results from that source" checked>'+this.filtersDatasets[a].prefLabel+(this.filtersDatasets[a].nbRecords==0?"":" ("+this.filtersDatasets[a].nbRecords+")")+"</label>"):$("#filter_dataset_"+a).append('<label><input class="datasetCheckbox" type="checkbox" name="filter_dataset_checkbox_'+a+'" id="filter_dataset_checkbox_'+
a+'" title="Only display results from that source">'+this.filtersDatasets[a].prefLabel+(this.filtersDatasets[a].nbRecords==0?"":" ("+this.filtersDatasets[a].nbRecords+")")+"</label>");$("#filter_dataset_checkbox_"+a).click(function(){b.datasetFilterCheck(this)});$("#filter_dataset_"+a).mouseover(function(){$(this).css("font-weight","bold")});$("#filter_dataset_"+a).mouseout(function(){$(this).css("font-weight","normal")})}$("#quicksearchinput_filterdatasets").quicksearch("div#webMapFiltersDataset div");
$("#quicksearchinput_filterdatasets").val(c);$("#quicksearchinput_filterdatasets").keyup()}};this.datasetFilterCheck=function(c){$(".tipsy").remove();var a=c.name.substring(c.name.lastIndexOf("_")+1);if(this.enableFocusWindows)this.focusMapsResults={1:null,2:null,3:null};if(c.checked){this.checkedFiltersDatasets.push(this.filtersDatasets[a].uri);this.currentResultsetPage=this.nbResults=0;this.session.fd=this.checkedFiltersDatasets}else{this.removeByElement(this.checkedFiltersDatasets,this.filtersDatasets[a].uri);
if(this.checkedFiltersDatasets.length==0)this.session.fd=[];this.currentResultsetPage=this.nbResults=0}this.search()};this.displayFiltersType=function(){$(".webMapFiltersTitleType").remove();$(".webMapFiltersType").remove();var c="";if($("#searchTypeFilterForm").length>0){c=$("#quicksearchinput_filtertypes").val();$("#searchTypeFilterForm").remove()}if(this.filtersTypes.length>0){$("#webMapFilters").append('<div id="webMapFiltersTitleType" class="webMapFiltersTitleType">'+this.labels.typesFilterSectionHeader+
"</div>");this.displayHelpTipsHover("webMapFiltersTitleType","Filter results by their kind","e");$("#webMapFilters").append('<form method="get" id="searchTypeFilterForm"><div style="padding-bottom: 5px;"><img src="'+this.imagesFolder+'magnifier.png" style="position: relative; top: 4px; left: 3px"> <input type="text" value="" name="q" id="quicksearchinput_filtertypes" style="margin-left: 4px" autocomplete="off" /></div></form>');this.displayHelpTipsHover("searchTypeFilterForm","Filter displayed kinds",
"e");$("#webMapFilters").append('<div id="webMapFiltersType" class="webMapFiltersType"></div>');for(var a=0;a<this.filtersTypes.length;a++){for(var e=false,d=0;d<this.schemas.length;d++){var f=this.schemas[d].getType(this.filtersTypes[a].uri);if(f!=null){f.ignoredBy!=void 0&&f.ignoredBy[0]=="http://purl.org/ontology/sco#sWebMap"&&(e=true);break}}if(!e){$("#webMapFiltersType").append('<div id="filter_type_'+a+'" class="webMapFiltersTypeItem"></div>');this.displayHelpTipsHover("filter_type_"+a,'Only shows result of kind "'+
this.filtersTypes[a].prefLabel+'"',"e");if(this.filtersTypes[a].nbRecords>0||this.checkedFiltersTypes.indexOf(this.filtersTypes[a].uri)!=-1){this.checkedFiltersTypes.indexOf(this.filtersTypes[a].uri)!=-1?$("#filter_type_"+a).append('<label><input class="typeCheckbox" type="checkbox" name="filter_type_checkbox_'+a+'" id="filter_type_checkbox_'+a+'" title="Only display results of that kind" checked>'+this.filtersTypes[a].prefLabel+(this.filtersTypes[a].nbRecords==0||this.displayTypeFiltersCounts==false?
"":" ("+this.filtersTypes[a].nbRecords+")")+"</label>"):$("#filter_type_"+a).append('<label><input class="typeCheckbox" type="checkbox" name="filter_type_checkbox_'+a+'" id="filter_type_checkbox_'+a+'" title="Only display results of that kind">'+this.filtersTypes[a].prefLabel+(this.filtersTypes[a].nbRecords==0||this.displayTypeFiltersCounts==false?"":" ("+this.filtersTypes[a].nbRecords+")")+"</label>");$("#filter_type_checkbox_"+a).click(function(){b.typeFilterCheck(this)});$("#filter_type_"+a).mouseover(function(){$(this).css("font-weight",
"bold")});$("#filter_type_"+a).mouseout(function(){$(this).css("font-weight","normal")})}}}$("#quicksearchinput_filtertypes").quicksearch("div#webMapFiltersType div");$("#quicksearchinput_filtertypes").val(c);$("#quicksearchinput_filtertypes").keyup()}};this.typeFilterCheck=function(c){$(".tipsy").remove();var a=c.name.substring(c.name.lastIndexOf("_")+1);if(this.enableFocusWindows)this.focusMapsResults={1:null,2:null,3:null};if(c.checked){this.checkedFiltersTypes.push(this.filtersTypes[a].uri);this.currentResultsetPage=
this.nbResults=0;this.session.ft=this.checkedFiltersTypes}else{this.removeByElement(this.checkedFiltersTypes,this.filtersTypes[a].uri);if(this.checkedFiltersTypes.length==0)this.session.ft=[];this.currentResultsetPage=this.nbResults=0}this.search()};this.displayFiltersAttribute=function(){$(".webMapFiltersTitleAttribute").remove();$(".webMapFiltersAttribute").remove();$(".webMapFiltersInputContainer").remove();if($("#searchAttributeFilterForm").length>0){var c=$("#quicksearchinput_filterattributes").val();
$("#searchAttributeFilterForm").remove()}if(this.filtersAttributes.length>0){$("#webMapFilters").append('<div id="webMapFiltersTitleAttribute" class="webMapFiltersTitleAttribute">'+this.labels.attributesFilterSectionHeader+"</div>");this.displayHelpTipsHover("webMapFiltersTitleAttribute","Filter results by their attributes","e");$("#webMapFilters").append('<div id="webMapFiltersInputContainer" class="webMapFiltersInputContainer"></div>');$("#webMapFilters").append('<form method="get" id="searchAttributeFilterForm"><div style="padding-bottom: 5px;"><img src="'+
this.imagesFolder+'magnifier.png" style="position: relative; top: 4px; left: 3px"> <input type="text" value="" name="q" id="quicksearchinput_filterattributes" style="margin-left: 4px" autocomplete="off" /></div></form>');this.displayHelpTipsHover("searchAttributeFilterForm","Filter displayed attributes","e");$("#webMapFilters").append('<div id="webMapFiltersAttribute" class="webMapFiltersAttribute"></div>');for(var a=0;a<this.filtersAttributes.length;a++){for(var e=false,d=0;d<this.schemas.length;d++){var f=
this.schemas[d].getAttribute(this.filtersAttributes[a].uri);if(f!=null){f.ignoredBy!=void 0&&f.ignoredBy[0]=="http://purl.org/ontology/sco#sWebMap"&&(e=true);break}}if(!e&&(this.filtersAttributes[a].nbRecords>0||this.checkedFiltersAttributes.indexOf(this.filtersAttributes[a].uri)!=-1)){$("#webMapFiltersAttribute").append('<div id="filter_attribute_'+a+'" class="webMapFiltersAttributeItem"></div>');if(this.attributeValueFilters[this.filtersAttributes[a].uri]==void 0){$("#filter_attribute_"+a).append('<img id="attributeFilterImage_'+
a+'" class="attributeFilterImage" src="'+this.imagesFolder+'magnifier_zoom_in.png" title="Add a value to filter by" />');this.displayHelpTipsHover("filter_attribute_"+a,'Shows results that have a certain value for the "'+this.filtersAttributes[a].prefLabel+'" attribute',"e");$("#attributeFilterImage_"+a).click(function(){var a=this.id.substring(this.id.lastIndexOf("_")+1);b.addFilterValue(a)})}else{$("#filter_attribute_"+a).append('<img id="attributeFilterImage_'+a+'" class="attributeFilterImage" src="'+
this.imagesFolder+'magifier_zoom_out.png" title="Remove the value filter for that attribute" />');this.displayHelpTipsHover("filter_attribute_"+a,"Remove this attribute/value filter","e");$("#attributeFilterImage_"+a).click(function(){var a=this.id.substring(this.id.lastIndexOf("_")+1);b.removeAttributeValueFilter(a)})}this.checkedFiltersAttributes.indexOf(this.filtersAttributes[a].uri)!=-1?$("#filter_attribute_"+a).append('<span id="attributeFilterCheckboxText_'+a+'">'+this.filtersAttributes[a].prefLabel+
" = <b>"+this.attributeValueFilters[this.filtersAttributes[a].uri]+"</b> "+(this.filtersAttributes[a].nbRecords==0||this.displayAttributeFiltersCounts==false?"":" ("+this.filtersAttributes[a].nbRecords+")")+"</span>"):$("#filter_attribute_"+a).append('<span id="attributeFilterCheckboxText_'+a+'">'+this.filtersAttributes[a].prefLabel+(this.filtersAttributes[a].nbRecords==0||this.displayAttributeFiltersCounts==false?"":" ("+this.filtersAttributes[a].nbRecords+")")+"</span>");$("#attributeFilterCheckboxText_"+
a).mouseover(function(){$(this).css("font-weight","bold")});$("#attributeFilterCheckboxText_"+a).mouseout(function(){$(this).css("font-weight","normal")});$("#attributeFilterCheckboxText_"+a).data("i",a);$("#attributeFilterCheckboxText_"+a).click(function(){var a=$(this).data("i");this.attributeValueFilters[this.filtersAttributes[a].uri]==void 0?this.addFilterValue(a):this.removeAttributeValueFilter(a)})}}$("#quicksearchinput_filterattributes").quicksearch("div#webMapFiltersAttribute div");$("#quicksearchinput_filterattributes").val(c);
$("#quicksearchinput_filterattributes").keyup()}};this.displaySearch=function(){$("#webMapSearch").append('<table width="100%"><tr><td width="100%"><div class="searchMapWrapper"><div class="inputMapWrapper"><input type="text" maxlength="2048" id="searchInput" class="searchBox" value="Search Map" style="font-style: italic" /></div></div></td><td width="0%"><div class="searchButtonMapWrapper"><input type="submit" class="searchButton" value=""></div></td></tr></table>');$(".searchBox").val(this.labels.searchInput);
$(".searchButton").val(this.labels.searchButton);$(".searchButton").click(function(){b.search()});$("#searchInput").focus(function(){if($(this).val()==b.labels.searchInput){$(this).val("");$(this).css("font-style","normal")}});$("#searchInput").blur(function(){if($(this).val()==""){$(this).val(b.labels.searchInput);$(this).css("font-style","italic")}});$("#searchInput").keypress(function(c){return b.submitSearchEnter(this,c)});$("#searchInput").tipsy({fade:true,gravity:"s",title:function(){return"Search for something specific"}});
this.enableSessions&&(this.getSessions().length<=0?$("#selectMapDiv").hide():$("#selectMapDiv").show())};this.clearMap=function(){this.checkedFiltersDatasets=[];this.checkedFiltersTypes=[];this.checkedFiltersAttributes=[];this.hideUntaggedRecords();this.displayResultsPagination(0,0);this.results=[];this.displayResults();this.filtersAttributes=[];this.filtersTypes=[];this.filtersDatasets=[];this.attributeValueFilters={};this.displayFiltersAttribute();this.displayFiltersType();this.displayFiltersDataset()};
this.loadMap=function(c){this.startWaiting();this.mapLoading=true;$("#searchInput").val(this.labels.searchInput);this.googleUrlShortenerKey!=""&&this.sharedMapUrl!=""&&$("#linkButtonDiv").hide();$("#deleteButtonDiv").hide();$("#importBox").is(":hidden")||$("#mapSessionsPanel").fadeOut("slow",function(){});this.taggedRecords=[];this.taggedResults=[];$("#taggedRecordsBox").empty();this.clearMap();var a;if(c.notes==void 0){c=$(c).children(":first").get(0);if(c.selectedIndex!=0){this.selectedMapId=c.value;
a=this.getSessions()[parseInt(c.value)]}}else a=c;if(a.fwe==void 0)a.fwe=false;if(a.fwe!=this.enableFocusWindows)if(window.location.toString().indexOf("?")==-1)window.location=window.location.toString()+"?map="+escape(JSON.stringify(a));else if(window.location.toString().indexOf("map=")==-1)window.location=window.location.toString()+"&map="+escape(JSON.stringify(a));else{var c=window.location.toString().indexOf("map="),b=window.location.toString().indexOf("&",c+1),d="",d=b==-1?window.location.toString().substring(0,
c):window.location.toString().substring(0,c)+window.location.toString().substring(b);window.location=d+"map="+escape(JSON.stringify(a))}this.googleUrlShortenerKey!=""&&this.sharedMapUrl!=""&&$("#linkButtonDiv").show();$("#deleteButtonDiv").show();google.maps.event.trigger(this.map,"resize");this.map.setZoom(this.map.getZoom());this.checkedFiltersDatasets=a.fd;this.checkedFiltersTypes=a.ft;this.checkedFiltersAttributes=a.fa;this.attributeValueFilters=a.av;$("#searchInput").val(a.q);this.session=a;
if(a.notes!=""){$("#mapSessionsMessagePanel").empty();$("#mapSessionsMessagePanel").append('<table style="margin: 20px;"><tbody style="border: none;"><tr><td><h2 style="margin: 0px;">Notes:</h2><br />'+this.session.notes+"</td></tr></tbody></table>");$("#mapSessionsMessagePanel").fadeIn("slow",function(){})}if(a.fwe){c=new google.maps.LatLngBounds;c=c.extend(new google.maps.LatLng(a.f1.nelat,a.f1.nelng));c=c.extend(new google.maps.LatLng(a.f1.swlat,a.f1.swlng));this.focusMaps[0].map.fitBounds(c);
this.focusMaps[0].map.setZoom(a.f1.z);c=new google.maps.LatLngBounds;c=c.extend(new google.maps.LatLng(a.f2.nelat,a.f2.nelng));c=c.extend(new google.maps.LatLng(a.f2.swlat,a.f2.swlng));this.focusMaps[1].map.fitBounds(c);this.focusMaps[0].map.setZoom(a.f2.z);c=new google.maps.LatLngBounds;c=c.extend(new google.maps.LatLng(a.f3.nelat,a.f3.nelng));c=c.extend(new google.maps.LatLng(a.f3.swlat,a.f3.swlng));this.focusMaps[2].map.fitBounds(c);this.focusMaps[0].map.setZoom(a.f3.z);if(a.f1.r.length>0){google.maps.event.trigger(this.focusMaps[0].map,
"click");for(c=0;c<a.f1.r.length;c++)this.tagRecord({},a.f1.r[c]);this.clearMap()}if(a.f2.r.length>0){google.maps.event.trigger(this.focusMaps[1].map,"click");for(c=0;c<a.f2.r.length;c++)this.tagRecord({},a.f2.r[c]);this.clearMap()}if(a.f3.r.length>0){google.maps.event.trigger(this.focusMaps[2].map,"click");for(c=0;c<a.f3.r.length;c++)this.tagRecord({},a.f3.r[c]);this.clearMap()}google.maps.event.trigger(this.focusMaps[a.sfw-1].map,"click");this.selectedFocusMapID=a.sfw;this.clearMap()}else for(c=
0;c<a.records.length;c++)this.tagRecord({},a.records[c]);c=false;if(a.fwe){if(a.f1.r.length>0||a.f2.r.length>0||a.f3.r.length>0)c=true}else a.records.length>0&&(c=true);if(c){this.forceSearch&&this.search();this.zoomToTaggedRecords()}else this.search();this.mapLoading=false;this.stopWaiting()};this.initializeMap=function(){this.session=this.initializationSession;if(this.session.sfw!=void 0)this.selectedFocusMapID=this.session.sfw;this.checkedFiltersDatasets=this.initializationSession.fd;this.checkedFiltersTypes=
this.initializationSession.ft;for(var c=0;c<this.initializationSession.records.length;c++)this.tagRecord({},this.initializationSession.records[c]);if(this.initializationSession.records.length<=0)this.search();else{this.forceSearch&&this.search();if(this.inclusionRecords.length>0){$("#inclusionButtonDiv").show();this.zoomToTaggedRecords()}}};this.deleteMap=function(){var c=this.getSessions();c.splice(this.selectedMapId,1);for(var a=0;a<256;a++)$.cookie("webmap-session-"+a)!=null&&$.cookie("webmap-session-"+
a,null);for(a=0;a<c.length;a++)$.cookie("webmap-session-"+a,JSON.stringify(c[a]),{expires:365,path:"/"});this.refreshMapSessionsList()};this.refreshMapSessionsList=function(){this.googleUrlShortenerKey!=""&&this.sharedMapUrl!=""&&$("#linkButtonDiv").hide();$("#deleteButtonDiv").hide();$("#mapsList").empty();$("#mapsList").append(this.getMapsListBoxOptions());this.getSessions().length<=0?$("#selectMapDiv").hide():$("#selectMapDiv").show()};this.getMapsListBoxOptions=function(){var c=this.getSessions(),
a='<option value="0" selected>'+this.labels.loadSavedMapSessionInput+"</option>";if(c.length>0)for(i=0;i<c.length;i++)a=a+('<option value="'+i+'">'+c[i].name+"</option>");return a};this.getSessions=function(){for(var c=[],a=0;a<256;a++)if($.cookie("webmap-session-"+a)==null)break;else c.push(JSON.parse($.cookie("webmap-session-"+a)));return c};this.saveMapPanel=function(){$("#mapSessionsPanel").is(":hidden")?$("#mapSessionsPanel").fadeIn("slow",function(){$("#mapSessionsPanel").empty();$("#mapSessionsPanel").append('<table style="padding-top: 20px;"><tbody style="border: none;"><tr><td style="padding-left: 20px;">session name:</td><td style="padding-right: 15px;"><input style="width: 100%" type="text" id="saveNameInput" /></td></tr><tr><td style="padding-left: 20px;">Notes:</td><td style="padding-right: 15px;"><textarea style="width: 100%" id="saveNotesInput" /></td></tr><tr><td colspan="2" align="center" style="padding-right: 15px;"><button id="saveSessionButton">Save session</button></td></tr></tbody></table>');
$("#saveSessionButton").click(function(){b.saveMap()})}):$("#mapSessionsPanel").fadeOut("slow",function(){})};this.linkMapPanel=function(){$("#mapSessionsPanel").is(":hidden")?$("#mapSessionsPanel").fadeIn("slow",function(){$("#mapSessionsPanel").empty();var c=b.getSessions(),a=b.sharedMapUrl,a=a+("?map="+escape(JSON.stringify(c[b.selectedMapId])));gapi.client.setApiKey(b.googleUrlShortenerKey);gapi.client.load("urlshortener","v1",function(){gapi.client.urlshortener.url.insert({resource:{longUrl:a}}).execute(function(a){if(a.error)$("#mapSessionsPanel").append('<table style="margin-top: 20px; margin-bottom: 20px;"><tbody style="border: none"><tr><td align="center">URL to this map session page: <input size="60" type="text" id="linkInput" value="Error: '+
a.error.message+'" /></td></tr></tbody></table>');else{$("#mapSessionsPanel").append('<table style="margin-top: 20px; margin-bottom: 20px;"><tbody style="border: none"><tr><td align="center">URL to this map session page: <input size="60" type="text" id="linkInput" value="'+a.id+'" /></td></tr></tbody></table>');$("#linkInput").focus(function(){this.select()})}})})}):$("#mapSessionsPanel").fadeOut("slow",function(){})};this.get_hostname=function(c){return(c=((c||"")+"").match(/^http:\/\/[^/]+/))?c[0]:
null};this.saveMap=function(){this.session=this.enableFocusWindows?{name:$("#saveNameInput").val(),notes:$("#saveNotesInput").val(),q:$("#searchInput").val()==this.labels.searchInput?"":$("#searchInput").val(),fd:this.checkedFiltersDatasets,fa:this.checkedFiltersAttributes,ft:this.checkedFiltersTypes,av:this.attributeValueFilters,attributes_boolean_operator:"and",fwe:true,sfw:this.selectedFocusMapID,f1:{nelat:this.focusMaps[0].map.getBounds().getNorthEast().lat(),nelng:this.focusMaps[0].map.getBounds().getNorthEast().lng(),
swlat:this.focusMaps[0].map.getBounds().getSouthWest().lat(),swlng:this.focusMaps[0].map.getBounds().getSouthWest().lng(),z:this.focusMaps[0].map.getZoom(),r:this.focusMapsTaggedRecords[1]},f2:{nelat:this.focusMaps[1].map.getBounds().getNorthEast().lat(),nelng:this.focusMaps[1].map.getBounds().getNorthEast().lng(),swlat:this.focusMaps[1].map.getBounds().getSouthWest().lat(),swlng:this.focusMaps[1].map.getBounds().getSouthWest().lng(),z:this.focusMaps[1].map.getZoom(),r:this.focusMapsTaggedRecords[2]},
f3:{nelat:this.focusMaps[2].map.getBounds().getNorthEast().lat(),nelng:this.focusMaps[2].map.getBounds().getNorthEast().lng(),swlat:this.focusMaps[2].map.getBounds().getSouthWest().lat(),swlng:this.focusMaps[2].map.getBounds().getSouthWest().lng(),z:this.focusMaps[2].map.getZoom(),r:this.focusMapsTaggedRecords[3]}}:{name:$("#saveNameInput").val(),notes:$("#saveNotesInput").val(),q:$("#searchInput").val()==this.labels.searchInput?"":$("#searchInput").val(),fd:this.checkedFiltersDatasets,fa:this.checkedFiltersAttributes,
ft:this.checkedFiltersTypes,av:this.attributeValueFilters,attributes_boolean_operator:"and",records:this.taggedRecords};$("#mapSessionsPanel").fadeOut("slow",function(){$("#saveNameInput").val("")});for(var c=0;c<256;c++)if($.cookie("webmap-session-"+c)==null)break;$.cookie("webmap-session-"+c,JSON.stringify(this.session),{expires:365,path:"/"});alert("Session Saved");this.refreshMapSessionsList()};this.submitSearchEnter=function(c,a){var b;if(window.event)b=window.event.keyCode;else if(a)b=a.which;
else return true;if(b==13){this.search();return false}return true};this.browse=function(){$("#searchInput").val(this.labels.searchInput);this.search()};this.removeByElement=function(c,a){for(var b=0;b<c.length;b++)c[b]==a&&c.splice(b,1)};this.addFilterValue=function(c){if(this.enableFocusWindows)this.focusMapsResults={1:null,2:null,3:null};this.attributeValueFilters[this.filtersAttributes[c].uri]==void 0&&(this.attributeValueFilters[this.filtersAttributes[c].uri]="");$("#attributeFilterImage_"+c).attr("src",
this.imagesFolder+"magnifier.png");$("#attributeFilterImage_"+c).attr("title","Add the value to filter in the input text above");$("#attributeFilterCheckboxText_"+c).hide();$("#attributeFilterCheckboxText_"+c).after('<table class="attributeFilterInputTable" id="attributeFilterInputTable_'+c+'"><tr><td>Filter:</td> <td><input class="webMapFiltersInputText" type="text" value="'+this.attributeValueFilters[this.filtersAttributes[c].uri]+'" id="webMapFiltersInputText_'+c+'" /></td><td><span id="addButton_'+
c+'"></span></td></tr></table>');$("#webMapFiltersInputText_"+c).keypress(function(a){return b.submitFilterEnter(this,a)});$("#attributeFilterInputTable_"+c).width($("#filter_attribute_"+c).width()-30);for(var a="",e=0;e<this.filtersDatasets.length;e++)this.checkedFiltersDatasets.length>0?this.checkedFiltersDatasets.indexOf(this.filtersDatasets[e].uri)!=-1&&(a=this.filtersDatasets[e].uri+";"):a=a+(this.filtersDatasets[e].uri+";");a.replace(/;+$/,"");for(var d="",e=0;e<this.checkedFiltersTypes.length;e++)d=
this.checkedFiltersTypes[e]+";";d==""?d="all":d.replace(/;+$/,"");attributeValueFiltersWSString="";for(var f in this.attributeValueFilters)f!=this.filtersAttributes[c].uri&&(attributeValueFiltersWSString=attributeValueFiltersWSString+(this.urlencode(f)+"::"+this.urlencode(this.attributeValueFilters[f])+";"));if(this.includeResultsInTargetInclusionRecords){for(e=0;e<this.inclusionRecords.length;e++)attributeValueFiltersWSString=attributeValueFiltersWSString+this.urlencode("http://www.geonames.org/ontology#locatedIn")+
"::"+this.urlencode(this.inclusionRecords[e])+";";this.session.attributes_boolean_operator=this.inclusionRecords.length>1?"or":"and"}f=this.map.getBounds();e=f.getNorthEast();f=f.getSouthWest();filterAc=$("#webMapFiltersInputText_"+c).autocomplete({serviceUrl:this.structWSFAddress+"search/",sWebMapRef:b,minChars:0,maxHeight:400,width:300,iconID:"searchButtonImage",zIndex:9999,onSelect:function(a){$("#webMapFiltersInputText_"+c).val(a.substring(0,a.lastIndexOf(" (")))},deferRequestBy:0,params:{q:$("#searchInput").val()==
this.labels.searchInput?"":$("#searchInput").val(),datasets:a,attributes:this.urlencode(this.filtersAttributes[c].uri),constrainedAttributes:attributeValueFiltersWSString,page:0,items:0,include_aggregates:"true",inference:"off",attributes_boolean_operator:this.session.attributes_boolean_operator,aggregate_attributes:this.urlencode(this.filtersAttributes[c].uri),types:d,range_filter:e.lat()+";"+e.lng()+";"+f.lat()+";"+f.lng(),filterID:c},noCache:false});filterAc.enable();$("#webMapFiltersInputText_"+
c).focus()};this.attributeValueFilter=function(c){$(".tipsy").remove();var a=$("#webMapFiltersInputText_"+c).val();if(a==""){$("#attributeFilterInputTable_"+c).remove();$("#attributeFilterImage_"+c).attr("src",this.imagesFolder+"magnifier_zoom_in.png");$("#attributeFilterImage_"+c).attr("title","Add a value to filter by");$("#attributeFilterCheckboxText_"+c).show();delete this.attributeValueFilters[this.filtersAttributes[c].uri]}else{$("#attributeFilterInputTable_"+c).remove();$("#attributeFilterCheckboxText_"+
c).show();$("#attributeFilterImage_"+c).attr("src",this.imagesFolder+"magifier_zoom_out.png");$("#attributeFilterImage_"+c).attr("title","Remove the value filter for that attribute");this.attributeValueFilters[this.filtersAttributes[c].uri]=a;this.checkedFiltersAttributes.push(this.filtersAttributes[c].uri);var b=$("#attributeFilterCheckboxText_"+c).html(),d=b.substring(b.lastIndexOf("(")+1,b.lastIndexOf(")"));b.lastIndexOf("=")==-1&&(b=b.substring(0,b.lastIndexOf("(")-1));$("#attributeFilterCheckboxText_"+
c).html(b+" = "+a+(this.displayAttributeFiltersCounts==false?"":" ("+d+")"));this.session.fa=this.filtersAttributes;this.session.av=this.attributeValueFilters;this.search()}};this.removeAttributeValueFilter=function(c){if(this.enableFocusWindows)this.focusMapsResults={1:null,2:null,3:null};$("#attributeFilterImage_"+c).attr("src",this.imagesFolder+"magnifier_zoom_in.png");$("#attributeFilterImage_"+c).attr("title","Add a value to filter by");delete this.attributeValueFilters[this.filtersAttributes[c].uri];
this.checkedFiltersAttributes.splice(this.checkedFiltersAttributes.indexOf(this.filtersAttributes[c].uri),1);delete this.checkedFiltersAttributes[this.filtersAttributes[c].uri];this.session.fa=this.checkedFiltersAttributes;this.session.av=this.attributeValueFilters;this.search()};this.getDatasetsTitles=function(){unparsedResultset=$.ajax({type:"GET",url:this.structWSFAddress.replace(/\/+$/,"")+"/dataset/read/?uri=all",dataType:"json",async:false}).responseText;var c=new Resultset(JSON.parse(unparsedResultset)),
a={},b;for(b in c.subjects)if(c.subjects.hasOwnProperty(b)){var d=c.subjects[b],f=d.getPredicateValues("http://purl.org/dc/terms/title");a[d.uri]=f[0]}$.cookie("webmap-datasetsTitles",escape(JSON.stringify(a)),{expires:365,path:"/"});this.datasetsTitles=a};this.submitFilterEnter=function(c,a){var b;if(window.event)b=window.event.keyCode;else if(a)b=a.which;else return true;if(b==13){this.attributeValueFilter(c.id.substring(c.id.lastIndexOf("_")+1));return false}return true};this.urlencode=function(c){c=
(c+"").toString();return encodeURIComponent(c).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")};this.getUrlVars=function(){for(var c=[],a,b=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),d=0;d<b.length;d++){a=b[d].split("=");c.push(a[0]);c[a[0]]=a[1]}return c};this.startWaiting=function(){$.blockUI({overlayCSS:{opacity:0},message:""})};this.stopWaiting=function(){$.unblockUI()};this.displayHelpTipsHover=
function(c,a,b){$("#"+c).tipsy({fade:true,trigger:"manual",gravity:b,title:function(){return a}});$("#"+c).mouseover(function(){$(this).tipsy("show")});$("#"+c).mouseout(function(){$(this).tipsy("hide")})};this.getResultDefinition=function(c){var a=c.getPredicateValues("http://purl.org/dc/terms/isPartOf")[0],b=c.getPredicateValues("http://www.w3.org/2003/01/geo/wgs84_pos#lat")[0],d=c.getPredicateValues("http://www.w3.org/2003/01/geo/wgs84_pos#long")[0],f="";if(b!=void 0&&d!=void 0&&b.length>0&&d.length>
0)for(b=0;b<this.schemas.length;b++){d=this.schemas[b].getType(c.type);if(d!=null&&d.mapMarkerImageUrl!=void 0&&d.mapMarkerImageUrl!=null){f=d.mapMarkerImageUrl[0];break}}var h="";c.getPredicateValues("http://purl.org/ontology/sco#polygonCoordinates").length>0&&(h="0xCA2251");var t="";c.getPredicateValues("http://purl.org/ontology/sco#polylineCoordinates").length>0&&(t="0xCA2251");for(var k="",b=0;b<this.schemas.length;b++){d=this.schemas[b].getType(c.type);if(d!=null){k=d.prefLabel;break}}return{uri:c.uri,
type:c.type,typePrefLabel:k,prefLabel:c.getPrefLabel(),description:c.getDescription(),prefURL:c.getPrefURL(),dataset:a!=void 0?a.uri:"",img:"",markerImageUrl:f,polygonColor:h,polylineColor:t,resultset:c}};this.SelectMapControl=function(c){$(c).append('<select id="mapsList" name="menu">'+b.getMapsListBoxOptions()+"</select>");$(c).change(function(){b.loadMap(this)})};this.SaveButtonControl=function(c){$(c).append('<input type="submit" value="'+b.labels.saveSessionButton+'" id="saveMapButtonControl">');
$(c).tipsy({fade:true,gravity:"n",title:function(){return"Save the state of the current map"}});$(c).click(function(){b.saveMapPanel()})};this.DeleteButtonControl=function(c){$(c).append('<input type="submit" value="'+b.labels.deleteSessionButton+'" id="deleteMapButtonControl">');$(c).tipsy({fade:true,gravity:"n",title:function(){return"Delete the current loaded map"}});$(c).click(function(){b.deleteMap()})};this.LinkButtonControl=function(c){$(c).append('<input type="submit" value="'+b.labels.shareSessionButton+
'" id="shareMapButtonControl">');$(c).tipsy({fade:true,gravity:"n",title:function(){return"Get a link to share this map with your friends and family"}});$(c).click(function(){b.linkMapPanel()})};this.InclusionButtonControl=function(c){this.includeResultsInTargetInclusionRecords?$(c).append('<input type="submit" id="inclusionButtonInput" value="'+b.labels.inclusionRecordsButtonOff+'">'):$(c).append('<input type="submit" id="inclusionButtonInput" value="'+b.labels.inclusionRecordsButtonOn+'">');$(c).click(function(){b.toggleInclusionRecordsFilter()});
$(c).tipsy({fade:true,gravity:"n",title:function(){return"Shows results in/out the region boundaries"}})};this.zoomToTaggedRecords=function(){for(var c=new google.maps.LatLngBounds,a=0;a<this.taggedRecords.length;a++){for(var b=0;b<this.polygons.length;b++)this.polygons[b].data.uri==this.taggedRecords[a]&&(c=c.union(this.polygons[b].bounds));for(b=0;b<this.polylines.length;b++)this.polylines[b].data.uri==this.taggedRecords[a]&&(c=c.union(this.polylines[b].bounds));for(b=0;b<this.markers.length;b++)this.markers[b].data.uri==
this.taggedRecords[a]&&(c=c.extend(this.markers[b].getPosition()))}this.map.fitBounds(c)};this.hideUntaggedRecords=function(){if(this.enableFocusWindows)var b=[];for(var a=0;a<this.markers.length;a++)this.taggedRecords.indexOf(this.markers[a].data.uri)<0?this.enableFocusWindows?this.markers[a].setMap(null):this.markers[a].setVisible(false):this.enableFocusWindows&&b.push(this.markers[a]);if(this.enableFocusWindows)this.markers=b;for(b=0;b<this.polygons.length;b++)this.taggedRecords.indexOf(this.polygons[b].data.uri)<
0&&this.polygons[b].setMap(null);for(b=0;this.polylines<this.polylines.length;b++)this.taggedRecords.indexOf(this.polylines[b].data.uri)<0&&this.polylines[b].setMap(null)};this.toggleInclusionRecordsFilter=function(){if(this.includeResultsInTargetInclusionRecords){this.includeResultsInTargetInclusionRecords=false;$("#inclusionButtonInput").val(this.labels.inclusionRecordsButtonOff)}else{this.includeResultsInTargetInclusionRecords=true;$("#inclusionButtonInput").val(this.labels.inclusionRecordsButtonOn)}this.search()};
this.openRecordDescriptionOverlay=function(c,a){var d="webMap";this.enableFocusWindows&&(d="resultsCanvas");var g=$("#"+d).position();$("#recordDescriptionOverlay").css({position:"absolute",top:g.top,left:g.left,width:$("#"+d).css("width"),height:$("#"+d).css("height")});var f="",f=a?"http://"+document.domain+"/conStruct/view/?uri="+this.urlencode(this.taggedResults[c].uri)+"&dataset="+this.urlencode(this.taggedResults[c].dataset):"http://"+document.domain+"/conStruct/view/?uri="+this.urlencode(this.results[c].uri)+
"&dataset="+this.urlencode(this.results[c].dataset),h=f+"&mime=template%2Fhtml";$("#recordDescriptionOverlay").html('<div style="width: 100%; height: 100%"><img id="recordDescriptionOverlayClose" title="Close popup" src="'+this.imagesFolder+'cross.png" style="position:relative; float: right; cursor: pointer; top: 3px; right: 3px;" /><img id="recordDescriptionOverlayOpen" title="Open in another window" src="'+this.imagesFolder+'application_double.png" style="position:relative; float: right; cursor: pointer; top: 4px; right: 9px;" /><iframe id="recordDescriptionFrame" src="'+
h+'" frameBorder="0" /></div>');$("#recordDescriptionOverlay > div").append('<div id="recordDescriptionLoading"><img src="'+this.imagesFolder+'/ajax-loading-bar.gif" /></div>');$("#recordDescriptionLoading").css({position:"absolute",top:g.top-($("#"+d).height()/2+10),left:g.left+($("#"+d).width()/2-110)});$("#recordDescriptionFrame").css({width:$("#"+d).css("width"),height:$("#"+d).height()-16+"px","padding-top":"16px","overflow-x":"hidden"});$("#recordDescriptionFrame").hide();$("#recordDescriptionFrame").load(function(){$("#recordDescriptionLoading").remove();
$("#recordDescriptionFrame").contents().find("head").append(b.recordDisplayCss);$("#recordDescriptionFrame").contents().find("a").attr("target","_new");var a=$("#recordDescriptionFrame").contents().find("title").text();$("#recordDescriptionFrame").contents().find("body").prepend("<h1>"+a+"</h1>");$("#recordDescriptionFrame").show()});$("#recordDescriptionOverlayClose").click(function(){b.closeRecordDescriptionOverlay()});$("#recordDescriptionOverlayOpen").click(function(){window.open(f,"_blank");
b.closeRecordDescriptionOverlay()});$("#recordDescriptionOverlay").fadeIn("fast",function(){})};this.closeRecordDescriptionOverlay=function(){$("#recordDescriptionOverlay").fadeOut("fast",function(){$("#recordDescriptionOverlay").empty()})};this.drawFocusPolygon=function(c,a){var a=this.hexc(a),d=new google.maps.MarkerImage(this.imagesFolder+"arrow_out.png",new google.maps.Size(16,16),new google.maps.Point(0,0),new google.maps.Point(8,8)),d=new google.maps.Marker({map:this.map,position:new google.maps.LatLng(c.map.getBounds().getNorthEast().lat(),
c.map.getBounds().getNorthEast().lng()),draggable:true,title:"Move focus window",icon:d});d.focusMap=c;var g=new google.maps.Rectangle({map:this.map,fillColor:a,fillOpacity:"0.3",strokeWeight:1,strokeColor:a,bounds:c.map.getBounds()});c.map.bindTo("center",d,"position");g.bindTo("bounds",c.map,"position");g.setBounds(c.map.getBounds());g.focusMap=c;google.maps.event.addListener(d,"dragend",function(){if(b.searchOnDrag){b.selectedFocusMapID=this.focusMap.focusMapID;this.focusMap.toggleFocusWindowSelection();
b.searchMap(this.focusMap.map)}});return g};this.hexc=function(b){if(b.indexOf("rgb(")==-1)return b.indexOf("#")==-1?"#"+b:b;b=b.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);delete b[0];for(var a=1;a<=3;++a){b[a]=parseInt(b[a]).toString(16);b[a].length==1&&(b[a]="0"+b[a])}return"#"+b.join("")};this.createWebMap(h);$(window).resize(function(){$("#webMap").width($("#webMap").parent().width());$(".webMapFiltersTd").width($("#webMap").width()*0.35);$(".webMapResultsTd").width($("#webMap").width()*0.65);
if(b.enableFocusWindows){$("#mapFocus1").css("width","100%");$("#mapFocus2").css("width","100%");$("#mapFocus3").css("width","100%");$("#mapFocus1").width($("#mapFocus1").width());$("#mapFocus2").width($("#mapFocus2").width());$("#mapFocus3").width($("#mapFocus3").width())}})}
function SWebMapFocus(){var h=this;this.focusPolygon=null;this.createFocusMap=function(d,b){this.sWebMap=d;this.color=$("#"+b).css("background-color");this.focusMapID=b.substring(b.length-1);var c={zoom:this.sWebMap.focusMapsCenterPositions["focusMap"+this.focusMapID].zoom,center:new google.maps.LatLng(this.sWebMap.focusMapsCenterPositions["focusMap"+this.focusMapID].lat,this.sWebMap.focusMapsCenterPositions["focusMap"+this.focusMapID].lng),disableDefaultUI:!0,mapTypeId:google.maps.MapTypeId.ROADMAP};
this.map=new google.maps.Map(document.getElementById(b),c);google.maps.event.addListenerOnce(this.map,"idle",function(){$("#mapFocus"+h.focusMapID).css("background-color","");google.maps.event.addListener(h.map,"bounds_changed",function(){null!=h.focusPolygon&&(h.focusPolygon.setBounds(h.map.getBounds()),h.focusMapID==h.sWebMap.selectedFocusMapID&&h.toggleFocusWindowSelection())});google.maps.event.addListener(h.map,"dragend",function(){h.sWebMap.searchOnDrag&&(h.sWebMap.selectedFocusMapID=h.focusMapID,
h.sWebMap.search())});google.maps.event.addListener(h.map,"zoom_changed",function(){h.sWebMap.searchOnZoomChanged&&(h.sWebMap.selectedFocusMapID=h.focusMapID,h.sWebMap.search())});google.maps.event.addListener(h.map,"click",function(){h.sWebMap.selectedFocusMapID=h.focusMapID;h.toggleFocusWindowSelection();null!=h.sWebMap.focusMapsResults[h.focusMapID]?h.sWebMap.prepareDisplayResults(h.sWebMap.focusMapsResults[h.focusMapID],h.map):h.sWebMap.search()});1==h.focusMapID&&(h.toggleFocusWindowSelection(),
h.sWebMap.selectedFocusMapID=h.focusMapID,h.sWebMap.search())})};this.toggleFocusWindowSelection=function(){$("#mapFocus"+h.focusMapID).removeClass("mapFocus"+h.focusMapID+"_unselected");$("#mapFocus"+h.focusMapID).addClass("mapFocus"+h.focusMapID+"_selected");1!=h.focusMapID&&($("#mapFocus1").removeClass("mapFocus1_selected"),$("#mapFocus1").addClass("mapFocus1_unselected"));2!=h.focusMapID&&($("#mapFocus2").removeClass("mapFocus2_selected"),$("#mapFocus2").addClass("mapFocus2_unselected"));3!=h.focusMapID&&
($("#mapFocus3").removeClass("mapFocus3_selected"),$("#mapFocus3").addClass("mapFocus3_unselected"))}};